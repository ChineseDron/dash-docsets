<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Generate a keyed hash value using the HMAC method</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.hash-hmac-file.html">hash_hmac_file</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.hash-init.html">hash_init</a></div>
 <div class="up"><a href="ref.hash.html">Hash Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.hash-hmac" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">hash_hmac</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.2, PECL hash &gt;= 1.1)</p><p class="refpurpose"><span class="refname">hash_hmac</span> &mdash; <span class="dc-title">Generate a keyed hash value using the HMAC method</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.hash-hmac-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><b>hash_hmac</b></span>
    ( <span class="methodparam"><span class="type">string</span> <tt class="parameter">$algo</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$data</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$key</tt></span>
   [, <span class="methodparam"><span class="type">bool</span> <tt class="parameter">$raw_output</tt><span class="initializer"> = false</span></span>
  ] )</div>


 </div>

 <div class="refsect1 parameters" id="refsect1-function.hash-hmac-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">algo</tt></i></span>
     <dd>

      <p class="para">
       Name of selected hashing algorithm (i.e. &quot;md5&quot;, &quot;sha256&quot;, &quot;haval160,4&quot;, etc..) See <span class="function"><a href="function.hash-algos.html" class="function">hash_algos()</a></span> for a list of supported algorithms.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">data</tt></i></span>
     <dd>

      <p class="para">
       Message to be hashed.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">key</tt></i></span>
     <dd>

      <p class="para">
       Shared secret key used for generating the HMAC variant of the message digest.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">raw_output</tt></i></span>
     <dd>

      <p class="para">
       When set to <b><tt>TRUE</tt></b>, outputs raw binary data.
       <b><tt>FALSE</tt></b> outputs lowercase hexits.
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.hash-hmac-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns a string containing the calculated message digest as lowercase hexits
   unless <i><tt class="parameter">raw_output</tt></i> is set to true in which case the raw
   binary representation of the message digest is returned.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.hash-hmac-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   <div class="example" id="example-876">
    <p><b>Example #1 <span class="function"><b>hash_hmac()</b></span> example</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">hash_hmac</span><span style="color: #007700">(</span><span style="color: #DD0000">'ripemd160'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'The&nbsp;quick&nbsp;brown&nbsp;fox&nbsp;jumped&nbsp;over&nbsp;the&nbsp;lazy&nbsp;dog.'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'secret'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
b8e7ae12510bdfb1812e463a7f086122cf37e4f7
</pre></div>
    </div>
   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.hash-hmac-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.hash.html" class="function" rel="rdfs-seeAlso">hash()</a> - Generate a hash value (message digest)</span></li>
    <li class="member"><span class="function"><a href="function.hash-algos.html" class="function" rel="rdfs-seeAlso">hash_algos()</a> - Return a list of registered hashing algorithms</span></li>
    <li class="member"><span class="function"><a href="function.hash-init.html" class="function" rel="rdfs-seeAlso">hash_init()</a> - Initialize an incremental hashing context</span></li>
    <li class="member"><span class="function"><a href="function.hash-hmac-file.html" class="function" rel="rdfs-seeAlso">hash_hmac_file()</a> - Generate a keyed hash value using the HMAC method and the contents of a given file</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="105099""></a>
  <div class="note">
   <strong class="user">josefkoh at hotmail dot com</strong>
   <a href="#105099" class="date">27-Jul-2011 10:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Simple implementation of hmac sha1<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">hmac_sha1</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Adjust key to exactly 64 bytes<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">) &gt; </span><span class="default">64</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">), </span><span class="default">64</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">) &lt; </span><span class="default">64</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">64</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Outter and Inner pad<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$opad </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x5C</span><span class="keyword">), </span><span class="default">64</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ipad </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x36</span><span class="keyword">), </span><span class="default">64</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Xor key with opad &amp; ipad<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$opad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$opad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ^ </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ipad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$ipad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ^ </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$opad</span><span class="keyword">.</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$ipad</span><span class="keyword">.</span><span class="default">$data</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">));<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101540""></a>
  <div class="note">
   <strong class="user">Peter Terence Roux</strong>
   <a href="#101540" class="date">23-Dec-2010 03:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The Implementation of the PBKDF2 key derivation function as described in RFC 2898 can be used to not only get the hashed KEY but also a specific IV.<br />
<br />
To use, one would use it as follows:-<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $p </span><span class="keyword">= </span><span class="default">str_hash_pbkdf2</span><span class="keyword">(</span><span class="default">$pw</span><span class="keyword">, </span><span class="default">$salt</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">32</span><span class="keyword">, </span><span class="string">'sha1'</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$p </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">str_hash_pbkdf2</span><span class="keyword">(</span><span class="default">$pw</span><span class="keyword">, </span><span class="default">$salt</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">, </span><span class="default">16</span><span class="keyword">, </span><span class="string">'sha1'</span><span class="keyword">, </span><span class="default">32</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
The function should be:-<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="comment">// PBKDF2 Implementation (described in RFC 2898)<br />
&nbsp; //<br />
&nbsp; // @param&nbsp;&nbsp; string&nbsp; p&nbsp;&nbsp; password<br />
&nbsp; // @param&nbsp;&nbsp; string&nbsp; s&nbsp;&nbsp; salt<br />
&nbsp; // @param&nbsp;&nbsp; int&nbsp; &nbsp;&nbsp; c&nbsp;&nbsp; iteration count (use 1000 or higher)<br />
&nbsp; // @param&nbsp;&nbsp; int&nbsp; &nbsp;&nbsp; kl&nbsp; derived key length<br />
&nbsp; // @param&nbsp;&nbsp; string&nbsp; a&nbsp;&nbsp; hash algorithm<br />
&nbsp; // @param&nbsp;&nbsp; int&nbsp; &nbsp;&nbsp; st&nbsp; start position of result<br />
&nbsp; //<br />
&nbsp; // @return&nbsp; string&nbsp; derived key<br />
&nbsp; </span><span class="keyword">function </span><span class="default">str_hash_pbkdf2</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">, </span><span class="default">$s</span><span class="keyword">, </span><span class="default">$c</span><span class="keyword">, </span><span class="default">$kl</span><span class="keyword">, </span><span class="default">$a </span><span class="keyword">= </span><span class="string">'sha256'</span><span class="keyword">, </span><span class="default">$st</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$kb </span><span class="keyword">= </span><span class="default">$start</span><span class="keyword">+</span><span class="default">$kl</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Key blocks to compute<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dk </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Derived key<br />
<br />
&nbsp;&nbsp;&nbsp; // Create key<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$block</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">; </span><span class="default">$block</span><span class="keyword">&lt;=</span><span class="default">$kb</span><span class="keyword">; </span><span class="default">$block</span><span class="keyword">++)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// Initial hash for this block<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$ib </span><span class="keyword">= </span><span class="default">$h </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">, </span><span class="default">$s </span><span class="keyword">. </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'N'</span><span class="keyword">, </span><span class="default">$block</span><span class="keyword">), </span><span class="default">$p</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// Perform block iterations<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$c</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// XOR each iterate<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ib </span><span class="keyword">^= (</span><span class="default">$h </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">, </span><span class="default">$h</span><span class="keyword">, </span><span class="default">$p</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$dk </span><span class="keyword">.= </span><span class="default">$ib</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Append iterated block<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Return derived key of correct length<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$dk</span><span class="keyword">, </span><span class="default">$start</span><span class="keyword">, </span><span class="default">$kl</span><span class="keyword">);<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100351""></a>
  <div class="note">
   <strong class="user">Siann Beck</strong>
   <a href="#100351" class="date">10-Oct-2010 09:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For signing an Amazon AWS query, base64-encode the binary value:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $Sig </span><span class="keyword">= </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="string">'sha256'</span><span class="keyword">, </span><span class="default">$Request</span><span class="keyword">, </span><span class="default">$AmazonSecretKey</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93440""></a>
  <div class="note">
   <strong class="user">KC Cloyd</strong>
   <a href="#93440" class="date">09-Sep-2009 11:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Sometimes a hosting provider doesn't provide access to the Hash extension. Here is a clone of the hash_hmac function you can use in the event you need an HMAC generator and Hash is not available. It's only usable with MD5 and SHA1 encryption algorithms, but its output is identical to the official hash_hmac function (so far at least).<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">custom_hmac</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$raw_output </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$algo </span><span class="keyword">= </span><span class="default">strtolower</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pack </span><span class="keyword">= </span><span class="string">'H'</span><span class="keyword">.</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">(</span><span class="string">'test'</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$size </span><span class="keyword">= </span><span class="default">64</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$opad </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x5C</span><span class="keyword">), </span><span class="default">$size</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ipad </span><span class="keyword">= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x36</span><span class="keyword">), </span><span class="default">$size</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">) &gt; </span><span class="default">$size</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">pack</span><span class="keyword">(</span><span class="default">$pack</span><span class="keyword">, </span><span class="default">$algo</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">)), </span><span class="default">$size</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x00</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$size</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0x00</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$opad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$opad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ^ </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ipad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$ipad</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] ^ </span><span class="default">$key</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$output </span><span class="keyword">= </span><span class="default">$algo</span><span class="keyword">(</span><span class="default">$opad</span><span class="keyword">.</span><span class="default">pack</span><span class="keyword">(</span><span class="default">$pack</span><span class="keyword">, </span><span class="default">$algo</span><span class="keyword">(</span><span class="default">$ipad</span><span class="keyword">.</span><span class="default">$data</span><span class="keyword">)));<br />
<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$raw_output</span><span class="keyword">) ? </span><span class="default">pack</span><span class="keyword">(</span><span class="default">$pack</span><span class="keyword">, </span><span class="default">$output</span><span class="keyword">) : </span><span class="default">$output</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Example Use:<br />
<br />
<span class="default">&lt;?php<br />
<br />
custom_hmac</span><span class="keyword">(</span><span class="string">'sha1'</span><span class="keyword">, </span><span class="string">'Hello, world!'</span><span class="keyword">, </span><span class="string">'secret'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92684""></a>
  <div class="note">
   <strong class="user">Henry Merriam</strong>
   <a href="#92684" class="date">03-Aug-2009 10:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Implementation of the PBKDF2 key derivation function as described in RFC 2898.<br />
&nbsp;* <br />
&nbsp;* PBKDF2 was published as part of PKCS #5 v2.0 by RSA Security. The standard is<br />
&nbsp;* also documented in IETF RFC 2898.<br />
&nbsp;* <br />
&nbsp;* The first four function arguments are as the standard describes:<br />
&nbsp;* <br />
&nbsp;*&nbsp; &nbsp;&nbsp; PBKDF2(P, S, c, dkLen)<br />
&nbsp;* <br />
&nbsp;* The fifth function argument specifies the hash function to be used. This should<br />
&nbsp;* be provided in the same format as used for the hash() function. The default<br />
&nbsp;* hash algorithm is SHA-1, but this is not recommended for new applications.<br />
&nbsp;*<br />
&nbsp;* The function returns false if dk_len is too large. Otherwise it returns the<br />
&nbsp;* derived key as a binary string.<br />
&nbsp;*<br />
&nbsp;* @author Henry Merriam &lt;php@henrymerriam.com&gt;<br />
&nbsp;* <br />
&nbsp;* @param&nbsp; &nbsp; string&nbsp; &nbsp; p&nbsp; &nbsp; &nbsp; &nbsp; password<br />
&nbsp;* @param&nbsp; &nbsp; string&nbsp; &nbsp; s&nbsp; &nbsp; &nbsp; &nbsp; salt<br />
&nbsp;* @param&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp; &nbsp; c&nbsp; &nbsp; &nbsp; &nbsp; iteration count<br />
&nbsp;* @param&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp; &nbsp; dk_len&nbsp; &nbsp; derived key length (octets)<br />
&nbsp;* @param&nbsp; &nbsp; string&nbsp; &nbsp; algo&nbsp; &nbsp; hash algorithm<br />
&nbsp;* <br />
&nbsp;* @return&nbsp; &nbsp; string&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; derived key<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">pbkdf2</span><span class="keyword">(</span><span class="default">$p</span><span class="keyword">, </span><span class="default">$s</span><span class="keyword">, </span><span class="default">$c</span><span class="keyword">, </span><span class="default">$dk_len</span><span class="keyword">, </span><span class="default">$algo </span><span class="keyword">= </span><span class="string">'sha1'</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// experimentally determine h_len for the algorithm in question<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">static </span><span class="default">$lengths</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (!isset(</span><span class="default">$lengths</span><span class="keyword">[</span><span class="default">$algo</span><span class="keyword">])) { </span><span class="default">$lengths</span><span class="keyword">[</span><span class="default">$algo</span><span class="keyword">] = </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">hash</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">)); }&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$h_len </span><span class="keyword">= </span><span class="default">$lengths</span><span class="keyword">[</span><span class="default">$algo</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$dk_len </span><span class="keyword">&gt; (</span><span class="default">pow</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">, </span><span class="default">32</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">) * </span><span class="default">$h_len</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">; </span><span class="comment">// derived key is too long<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">} else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$l </span><span class="keyword">= </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">$dk_len </span><span class="keyword">/ </span><span class="default">$h_len</span><span class="keyword">); </span><span class="comment">// number of derived key blocks to compute<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$t </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">$l</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$f </span><span class="keyword">= </span><span class="default">$u </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">, </span><span class="default">$s </span><span class="keyword">. </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'N'</span><span class="keyword">, </span><span class="default">$i</span><span class="keyword">), </span><span class="default">$p</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">); </span><span class="comment">// first iterate<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$j </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$j </span><span class="keyword">&lt; </span><span class="default">$c</span><span class="keyword">; </span><span class="default">$j</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$f </span><span class="keyword">^= (</span><span class="default">$u </span><span class="keyword">= </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="default">$algo</span><span class="keyword">, </span><span class="default">$u</span><span class="keyword">, </span><span class="default">$p</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">)); </span><span class="comment">// xor each iterate<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$t </span><span class="keyword">.= </span><span class="default">$f</span><span class="keyword">; </span><span class="comment">// concatenate blocks of the derived key<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$t</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$dk_len</span><span class="keyword">); </span><span class="comment">// return the derived key of correct length<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91031""></a>
  <div class="note">
   <strong class="user">brent at thebrent dot net</strong>
   <a href="#91031" class="date">21-May-2009 08:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The hotp algorithms above work with counter values less than 256, but since the counter can be larger, it's necessary to iterate through all the bytes of the counter:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">oath_hotp </span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Counter<br />
&nbsp;&nbsp;&nbsp; //the counter value can be more than one byte long, so we need to go multiple times<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cur_counter </span><span class="keyword">= array(</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">7</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&gt;=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">--)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cur_counter</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">pack </span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$counter </span><span class="keyword">= </span><span class="default">$counter </span><span class="keyword">&gt;&gt; </span><span class="default">8</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$bin_counter </span><span class="keyword">= </span><span class="default">implode</span><span class="keyword">(</span><span class="default">$cur_counter</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Pad to 8 chars<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$bin_counter</span><span class="keyword">) &lt; </span><span class="default">8</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bin_counter </span><span class="keyword">= </span><span class="default">str_repeat </span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">), </span><span class="default">8 </span><span class="keyword">- </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$bin_counter</span><span class="keyword">)) . </span><span class="default">$bin_counter</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// HMAC<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$hash </span><span class="keyword">= </span><span class="default">hash_hmac </span><span class="keyword">(</span><span class="string">'sha1'</span><span class="keyword">, </span><span class="default">$bin_counter</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$hash</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">oath_truncate</span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">, </span><span class="default">$length </span><span class="keyword">= </span><span class="default">6</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Convert to dec<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">foreach(</span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">) as </span><span class="default">$hex</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$hmac_result</span><span class="keyword">[]=</span><span class="default">hexdec</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Find offset<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">19</span><span class="keyword">] &amp; </span><span class="default">0xf</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Algorithm from RFC<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return<br />
&nbsp;&nbsp;&nbsp; (<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">] &amp; </span><span class="default">0x7f</span><span class="keyword">) &lt;&lt; </span><span class="default">24 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">) &lt;&lt; </span><span class="default">16 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">2</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">) &lt;&lt; </span><span class="default">8 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">3</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; ) % </span><span class="default">pow</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">,</span><span class="default">$length</span><span class="keyword">);<br />
}<br />
print </span><span class="string">"&lt;pre&gt;"</span><span class="keyword">;<br />
print </span><span class="string">"Compare results with:"</span><span class="keyword">;<br />
print </span><span class="string">" <a href="http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04" rel="nofollow" target="_blank">http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04</a>\n"</span><span class="keyword">;<br />
print </span><span class="string">"Count\tHash\t\t\t\t\t\tPin\n"</span><span class="keyword">;<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;=</span><span class="default">1024</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">=</span><span class="default">$i</span><span class="keyword">+</span><span class="default">128</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; print </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\t"</span><span class="keyword">.(</span><span class="default">$a</span><span class="keyword">=</span><span class="default">oath_hotp</span><span class="keyword">(</span><span class="string">"12345678901234567890"</span><span class="keyword">,</span><span class="default">$i</span><span class="keyword">));<br />
&nbsp;&nbsp; print </span><span class="string">"\t"</span><span class="keyword">.</span><span class="default">oath_truncate</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89769""></a>
  <div class="note">
   <strong class="user">torben dot egmose at gmail dot com</strong>
   <a href="#89769" class="date">22-Mar-2009 11:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
HOTP Algorithm that works according to the RCF <a href="http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04" rel="nofollow" target="_blank">http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04</a><br />
The test cases from the RCF document the ASCII string as "123456787901234567890".<br />
But the hex decoded to a string is "12345678901234567890".<br />
Secret="12345678901234567890";<br />
Count:<br />
0 755224<br />
1 287082<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">oath_hotp</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$counter</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// Convert to padded binary string<br />
&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">pack </span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">str_pad</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">8</span><span class="keyword">,</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">),</span><span class="default">STR_PAD_LEFT</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// HMAC<br />
&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">hash_hmac</span><span class="keyword">(</span><span class="string">'sha1'</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$key</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">oath_truncate</span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">, </span><span class="default">$length </span><span class="keyword">= </span><span class="default">6</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// Convert to dec<br />
&nbsp;&nbsp; </span><span class="keyword">foreach(</span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">) as </span><span class="default">$hex</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$hmac_result</span><span class="keyword">[]=</span><span class="default">hexdec</span><span class="keyword">(</span><span class="default">$hex</span><span class="keyword">);<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// Find offset<br />
&nbsp;&nbsp; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">19</span><span class="keyword">] &amp; </span><span class="default">0xf</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// Algorithm from RFC<br />
&nbsp;&nbsp; </span><span class="keyword">return (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">0</span><span class="keyword">] &amp; </span><span class="default">0x7f</span><span class="keyword">) &lt;&lt; </span><span class="default">24 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">) &lt;&lt; </span><span class="default">16 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ((</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">2</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">) &lt;&lt; </span><span class="default">8 </span><span class="keyword">) |<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="default">$hmac_result</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">+</span><span class="default">3</span><span class="keyword">] &amp; </span><span class="default">0xff</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ) % </span><span class="default">pow</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">,</span><span class="default">$length</span><span class="keyword">);<br />
}<br />
<br />
print </span><span class="string">"&lt;pre&gt;"</span><span class="keyword">;<br />
print </span><span class="string">"Compare results with:"<br />
</span><span class="keyword">print </span><span class="string">" <a href="http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04" rel="nofollow" target="_blank">http://tools.ietf.org/html/draft-mraihi-oath-hmac-otp-04</a>\n"</span><span class="keyword">;<br />
print </span><span class="string">"Count\tHash\t\t\t\t\t\tPin\n"</span><span class="keyword">;<br />
for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">10</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; print </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\t"</span><span class="keyword">.(</span><span class="default">$a</span><span class="keyword">=</span><span class="default">oath_hotp</span><span class="keyword">(</span><span class="string">"12345678901234567890"</span><span class="keyword">,</span><span class="default">$i</span><span class="keyword">))<br />
&nbsp;&nbsp; print </span><span class="string">"\t"</span><span class="keyword">.</span><span class="default">oath_truncate</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84223""></a>
  <div class="note">
   <strong class="user">Carlos Averett(caverett*@*corecodec,net)</strong>
   <a href="#84223" class="date">03-Jul-2008 03:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Generating OATH-compliant OTP (one time passwords) results in PHP:<br />
<br />
<span class="default">&lt;?php<br />
$otp </span><span class="keyword">= </span><span class="default">oath_truncate </span><span class="keyword">(</span><span class="default">oath_hotp </span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">), </span><span class="default">$length</span><span class="keyword">);<br />
function </span><span class="default">oath_hotp </span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Counter<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bin_counter </span><span class="keyword">= </span><span class="default">pack </span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$counter</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Pad to 8 chars<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$bin_counter</span><span class="keyword">) &lt; </span><span class="default">8</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bin_counter </span><span class="keyword">= </span><span class="default">str_repeat </span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">), </span><span class="default">8 </span><span class="keyword">- </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$bin_counter</span><span class="keyword">)) . </span><span class="default">$bin_counter</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// HMAC<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$hash </span><span class="keyword">= </span><span class="default">hash_hmac </span><span class="keyword">(</span><span class="string">'sha1'</span><span class="keyword">, </span><span class="default">$bin_counter</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$hash</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">oath_truncate </span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">, </span><span class="default">$length </span><span class="keyword">= </span><span class="default">6</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// The last byte is used as an offset<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">hexdec </span><span class="keyword">(</span><span class="default">substr </span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">, </span><span class="default">38</span><span class="keyword">)) &amp; </span><span class="default">0xf</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Extract the relevant part, and clear the first bit<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$hex_truncated </span><span class="keyword">= </span><span class="default">substr </span><span class="keyword">(</span><span class="default">$hash</span><span class="keyword">, </span><span class="default">$offset </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">, </span><span class="default">8</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bin_truncated </span><span class="keyword">= </span><span class="default">decbin </span><span class="keyword">(</span><span class="default">hexdec </span><span class="keyword">(</span><span class="default">$hex_truncated</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bin_truncated</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] = </span><span class="string">'0'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dec_truncated </span><span class="keyword">= </span><span class="default">bindec </span><span class="keyword">(</span><span class="default">$bin_truncated</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">substr </span><span class="keyword">(</span><span class="default">$dec_truncated</span><span class="keyword">, </span><span class="default">0 </span><span class="keyword">- </span><span class="default">$length</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.hash-hmac-file.html">hash_hmac_file</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.hash-init.html">hash_init</a></div>
 <div class="up"><a href="ref.hash.html">Hash Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
