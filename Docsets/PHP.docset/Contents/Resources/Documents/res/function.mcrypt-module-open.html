<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Opens the module of the algorithm and the mode to be used</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.mcrypt-module-is-block-mode.html">mcrypt_module_is_block_mode</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.mcrypt-module-self-test.html">mcrypt_module_self_test</a></div>
 <div class="up"><a href="ref.mcrypt.html">Mcrypt Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.mcrypt-module-open" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mcrypt_module_open</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.2, PHP 5)</p><p class="refpurpose"><span class="refname">mcrypt_module_open</span> &mdash; <span class="dc-title">Opens the module of the algorithm and the mode to be used</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.mcrypt-module-open-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><b>mcrypt_module_open</b></span>
    ( <span class="methodparam"><span class="type">string</span> <tt class="parameter">$algorithm</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$algorithm_directory</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$mode</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$mode_directory</tt></span>
   )</div>

  <p class="para rdfs-comment">
   This function opens the module of the algorithm and the mode to be used.
   The name of the algorithm is specified in algorithm, e.g. <i>&quot;twofish&quot;</i> or is
   one of the <b><tt>MCRYPT_ciphername</tt></b> constants.  The module is closed by calling
   <span class="function"><a href="function.mcrypt-module-close.html" class="function">mcrypt_module_close()</a></span>.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.mcrypt-module-open-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">algorithm</tt></i></span>
     <dd>

      <p class="para">
       The algorithm to be used.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">algorithm_directory</tt></i></span>
     <dd>

      <p class="para">
       The <i><tt class="parameter">algorithm_directory</tt></i> parameter is used to locate
       the encryption module. When you supply a directory name, it is used.  When
       you set it to an empty string (<i>&quot;&quot;</i>), the value set by the
       <i>mcrypt.algorithms_dir</i> <var class="filename">php.ini</var> directive is used. When
       it is not set, the default directory that is used is the one that was compiled
       into libmcrypt (usually <var class="filename">/usr/local/lib/libmcrypt</var>).
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">mode</tt></i></span>
     <dd>

      <p class="para">
       The mode to be used.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">mode_directory</tt></i></span>
     <dd>

      <p class="para">
       The <i><tt class="parameter">mode_directory</tt></i> parameter is used to locate
       the encryption module. When you supply a directory name, it is used.  When
       you set it to an empty string (<i>&quot;&quot;</i>), the value set by the
       <i>mcrypt.modes_dir</i> <var class="filename">php.ini</var> directive is used. When
       it is not set, the default directory that is used is the one that was compiled-in
       into libmcrypt (usually <var class="filename">/usr/local/lib/libmcrypt</var>).
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.mcrypt-module-open-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Normally it returns an encryption descriptor, or <b><tt>FALSE</tt></b> on error.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.mcrypt-module-open-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   <div class="example" id="example-893">
    <p><b>Example #1 <span class="function"><b>mcrypt_module_open()</b></span> Examples</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />&nbsp;&nbsp;&nbsp;&nbsp;$td&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_DES</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">MCRYPT_MODE_ECB</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'/usr/lib/mcrypt-modes'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$td&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'rijndael-256'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'ofb'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   The first line in the example above will try to open the <i>DES</i> cipher from
   the default directory and the <i>EBC</i> mode from the directory
   <var class="filename">/usr/lib/mcrypt-modes</var>. The second example uses
   strings as name for the cipher and mode, this only works when the
   extension is linked against libmcrypt 2.4.x or 2.5.x.
  </p>

  <p class="para">
   <div class="example" id="example-894">
    <p><b>Example #2 Using <span class="function"><b>mcrypt_module_open()</b></span> in encryption</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Open&nbsp;the&nbsp;cipher&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$td&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_module_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'rijndael-256'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'ofb'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Create&nbsp;the&nbsp;IV&nbsp;and&nbsp;determine&nbsp;the&nbsp;keysize&nbsp;length,&nbsp;use&nbsp;MCRYPT_RAND<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;Windows&nbsp;instead&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$iv&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">mcrypt_enc_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">),&nbsp;</span><span style="color: #0000BB">MCRYPT_DEV_RANDOM</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ks&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_enc_get_key_size</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Create&nbsp;key&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">md5</span><span style="color: #007700">(</span><span style="color: #DD0000">'very&nbsp;secret&nbsp;key'</span><span style="color: #007700">),&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ks</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Intialize&nbsp;encryption&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mcrypt_generic_init</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Encrypt&nbsp;data&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$encrypted&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mcrypt_generic</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'This&nbsp;is&nbsp;very&nbsp;important&nbsp;data'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Terminate&nbsp;encryption&nbsp;handler&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mcrypt_generic_deinit</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Initialize&nbsp;encryption&nbsp;module&nbsp;for&nbsp;decryption&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mcrypt_generic_init</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Decrypt&nbsp;encrypted&nbsp;string&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$decrypted&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mdecrypt_generic</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$encrypted</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Terminate&nbsp;decryption&nbsp;handle&nbsp;and&nbsp;close&nbsp;module&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mcrypt_generic_deinit</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mcrypt_module_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$td</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Show&nbsp;string&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">trim</span><span style="color: #007700">(</span><span style="color: #0000BB">$decrypted</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.mcrypt-module-open-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.mcrypt-module-close.html" class="function" rel="rdfs-seeAlso">mcrypt_module_close()</a> - Closes the mcrypt module</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic.html" class="function" rel="rdfs-seeAlso">mcrypt_generic()</a> - This function encrypts data</span></li>
    <li class="member"><span class="function"><a href="function.mdecrypt-generic.html" class="function" rel="rdfs-seeAlso">mdecrypt_generic()</a> - Decrypts data</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic-init.html" class="function" rel="rdfs-seeAlso">mcrypt_generic_init()</a> - This function initializes all buffers needed for encryption</span></li>
    <li class="member"><span class="function"><a href="function.mcrypt-generic-deinit.html" class="function" rel="rdfs-seeAlso">mcrypt_generic_deinit()</a> - This function deinitializes an encryption module</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="92339""></a>
  <div class="note">
   <strong class="user">lehmann*at*arcor-so.net</strong>
   <a href="#92339" class="date">20-Jul-2009 08:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Keep in mind that the mcrypt functions do not implement padding like e.g. pkcs#5. This causes the problem with zero bytes at the end and the sting cannot be correctly decoded in other environments.<br />
<br />
For an example how to add pkcs 5 padding, see ref.mcrypt.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89937""></a>
  <div class="note">
   <strong class="user">royconejo</strong>
   <a href="#89937" class="date">29-Mar-2009 09:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
about the previous comments on hex formatting and capitalization as a way to improve the key:<br />
<br />
this would seem pretty obvious, but it is a choice to be limited to only hex characters ([0-9a-z]); you can get the original RAW output from md5() or sha1() and not the default readable hex formatting.<br />
<br />
the result of a raw output will be 16 o 20 (depending on the hash function being used) series of chars in the range 0-255. way better than [0-9a-z] and even [0-9a-zA-Z].<br />
<br />
16 or 20 is generally lower than the maximum key lenght ($ks in the example), but you can append two or more keys together:<br />
<br />
<span class="default">&lt;?php<br />
$human_key1 </span><span class="keyword">= </span><span class="string">'something very secret'</span><span class="keyword">;<br />
</span><span class="default">$human_key2 </span><span class="keyword">= </span><span class="string">'something else very secret'</span><span class="keyword">;<br />
<br />
</span><span class="comment">// 40 bytes binary key using two "human readable" keys and sha1.<br />
</span><span class="default">$bigger_binary_key </span><span class="keyword">= </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$human_key1</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">) . </span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$human_key2</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="comment">// then just use it as you would (extract taken from the example)<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$bigger_binary_key</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
... or you can automatically split one large "human key" into two or more parts, hash those parts with sha1 (raw output!) and merge them together again (in original order or rearrange, salt, transform them as you like) to get a binary key of 40, 60, 80 or more chars depending on the number of parts the secret key has been splitted =)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84517""></a>
  <div class="note">
   <strong class="user">ash</strong>
   <a href="#84517" class="date">17-Jul-2008 03:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A slight improvement of dinamic's function to create a key:<br />
<br />
I think the weak point is that capitals are always used in the same part of the string. The following code capitalizes random characters of the string, making the key less predictable:<br />
<br />
<span class="default">&lt;?php<br />
$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">, (</span><span class="default">round</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)), </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">.</span><span class="default">$key2</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$ks</span><span class="keyword">);<br />
<br />
</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">);<br />
<br />
</span><span class="default">$limit </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">;<br />
</span><span class="default">srand</span><span class="keyword">((float)</span><span class="default">microtime</span><span class="keyword">() * </span><span class="default">1000000</span><span class="keyword">);<br />
<br />
</span><span class="default">$end </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">$limit</span><span class="keyword">);<br />
</span><span class="default">$a </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="comment">// replace random chars with capitals<br />
</span><span class="keyword">while (</span><span class="default">$a </span><span class="keyword">&lt; </span><span class="default">$end</span><span class="keyword">) {&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; list(</span><span class="default">$usec</span><span class="keyword">, </span><span class="default">$sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$seed </span><span class="keyword">= ((float)</span><span class="default">$sec</span><span class="keyword">) + ((float) </span><span class="default">$usec </span><span class="keyword">* </span><span class="default">100000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mt_srand</span><span class="keyword">(</span><span class="default">$seed</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$index </span><span class="keyword">= </span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">$limit</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer</span><span class="keyword">[</span><span class="default">$index</span><span class="keyword">] = </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">[</span><span class="default">$index</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$a</span><span class="keyword">++;<br />
}<br />
<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">join</span><span class="keyword">(</span><span class="string">''</span><span class="keyword">, </span><span class="default">$buffer</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79135""></a>
  <div class="note">
   <strong class="user">dinamic at gmail dot com</strong>
   <a href="#79135" class="date">13-Nov-2007 03:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also it should be pointed that md5() and/or sha1() should not be used while forming your key for the mcrypt. This is so because hex encoding uses a set of only 16 characters [0-9a-f], which is equivalent to 4 bits, and thus halve the strength of your encryption: 4 x 32 = 128-bit.<br />
<br />
I have re-wrote the example shown, so here is my suggestion to get real 256-bit encryption:<br />
<br />
<span class="default">&lt;?php<br />
$key1 </span><span class="keyword">= </span><span class="string">"this is a secret key"</span><span class="keyword">;<br />
</span><span class="default">$key2 </span><span class="keyword">= </span><span class="string">"this is the second secret key"</span><span class="keyword">;<br />
</span><span class="default">$input </span><span class="keyword">= </span><span class="string">"Let us meet at 9 o'clock at the secret place."</span><span class="keyword">;<br />
</span><span class="default">$length </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$input</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Open the cipher */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$td </span><span class="keyword">= </span><span class="default">mcrypt_module_open</span><span class="keyword">(</span><span class="string">'rijndael-256'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="string">'cbc'</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Create the IV and determine the keysize length, use MCRYPT_RAND<br />
&nbsp;&nbsp; &nbsp; * on Windows instead */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv</span><span class="keyword">(</span><span class="default">mcrypt_enc_get_iv_size</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">), </span><span class="default">MCRYPT_RAND</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ks </span><span class="keyword">= </span><span class="default">mcrypt_enc_get_key_size</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Create key */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key1 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key2 </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">), (</span><span class="default">round</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$key2</span><span class="keyword">) / </span><span class="default">2</span><span class="keyword">)), </span><span class="default">$ks</span><span class="keyword">/</span><span class="default">2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$key </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">.</span><span class="default">$key1</span><span class="keyword">.</span><span class="default">$key2</span><span class="keyword">.</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$key1</span><span class="keyword">),</span><span class="default">0</span><span class="keyword">,</span><span class="default">$ks</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Intialize encryption */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_init</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Encrypt data */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$encrypted </span><span class="keyword">= </span><span class="default">mcrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$input</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Terminate encryption handler */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_deinit</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Initialize encryption module for decryption */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_init</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Decrypt encrypted string */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">mdecrypt_generic</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">, </span><span class="default">$encrypted</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Terminate decryption handle and close module */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_generic_deinit</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mcrypt_module_close</span><span class="keyword">(</span><span class="default">$td</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Show string */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Text: "</span><span class="keyword">.</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$decrypted</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$length</span><span class="keyword">) . </span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Encoded: "</span><span class="keyword">.</span><span class="default">$encrypted </span><span class="keyword">.</span><span class="string">"&lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"&lt;br&gt;key1: </span><span class="default">$key1</span><span class="string"> &lt;br&gt;key2: </span><span class="default">$key2</span><span class="string">&lt;br&gt;created key: </span><span class="default">$key</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62543""></a>
  <div class="note">
   <strong class="user">Mon</strong>
   <a href="#62543" class="date">02-Mar-2006 03:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In the text example:<br />
<br />
$key = substr(md5('very secret key'), 0, $ks);<br />
<br />
Builds a key of $ks/2 effective bytes.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="34611""></a>
  <div class="note">
   
   <a href="#34611" class="date">31-Jul-2003 08:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Doing a trim($decrypted) will remove the null padding that may occur as a result of decryption.<br />
<br />
The problem is if you're encrypting something like a MSWord document which can commonly end with nulls. The result $decrypted will be smaller than the original cleartext - which will then fail to open in MSOffice.<br />
<br />
To get around this, make sure you store the length of the original cleartext, and when you decrypt it, do:<br />
<br />
$decrypted = substr(mdecrypt_generic($td, $encrypted), 0, $originalLength);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.mcrypt-module-is-block-mode.html">mcrypt_module_is_block_mode</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.mcrypt-module-self-test.html">mcrypt_module_self_test</a></div>
 <div class="up"><a href="ref.mcrypt.html">Mcrypt Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
