<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Reads a maximum of length bytes from a socket</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.socket-listen.html">socket_listen</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.socket-recv.html">socket_recv</a></div>
 <div class="up"><a href="ref.sockets.html">Socket Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.socket-read" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_read</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5)</p><p class="refpurpose"><span class="refname">socket_read</span> &mdash; <span class="dc-title">Reads a maximum of length bytes from a socket</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-read-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><b>socket_read</b></span>
    ( <span class="methodparam"><span class="type">resource</span> <tt class="parameter">$socket</tt></span>
   , <span class="methodparam"><span class="type">int</span> <tt class="parameter">$length</tt></span>
   [, <span class="methodparam"><span class="type">int</span> <tt class="parameter">$type</tt><span class="initializer"> = PHP_BINARY_READ</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   The function <span class="function"><b>socket_read()</b></span> reads from the socket
   resource <i><tt class="parameter">socket</tt></i> created by the
   <span class="function"><a href="function.socket-create.html" class="function">socket_create()</a></span> or
   <span class="function"><a href="function.socket-accept.html" class="function">socket_accept()</a></span> functions. 
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-read-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">socket</tt></i></span>
     <dd>

      <p class="para">
       A valid socket resource created with <span class="function"><a href="function.socket-create.html" class="function">socket_create()</a></span>
       or <span class="function"><a href="function.socket-accept.html" class="function">socket_accept()</a></span>.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">length</tt></i></span>
     <dd>

      <p class="para">
       The maximum number of bytes read is specified by the
       <i><tt class="parameter">length</tt></i> parameter. Otherwise you can use
       <b><tt>\r</tt></b>, <b><tt>\n</tt></b>,
       or <b><tt>\0</tt></b> to end reading (depending on the <i><tt class="parameter">type</tt></i>
       parameter, see below).
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">type</tt></i></span>
     <dd>

      <p class="para">
       Optional <i><tt class="parameter">type</tt></i> parameter is a named constant:
       <ul class="itemizedlist">
        <li class="listitem">
         <span class="simpara">
          <b><tt>PHP_BINARY_READ</tt></b> (Default) - use the system
          <i>recv()</i> function. Safe for reading binary data.
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <b><tt>PHP_NORMAL_READ</tt></b> - reading stops at
          <i>\n</i> or <i>\r</i>.
         </span>
        </li>
       </ul>
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-read-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   <span class="function"><b>socket_read()</b></span> returns the data as a string on success,
   or <b><tt>FALSE</tt></b> on error (including if the remote host has closed the
   connection). The error code can be retrieved with
   <span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span>. This code may be passed to
   <span class="function"><a href="function.socket-strerror.html" class="function">socket_strerror()</a></span> to get a textual representation of
   the error.
  </p>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <p class="para">
    <span class="function"><b>socket_read()</b></span> returns a zero length string (&quot;&quot;)
    when there is no more data to read.
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.socket-read-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead valign="middle">
      <tr valign="middle">
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody valign="middle" class="tbody">
      <tr valign="middle">
       <td align="left">4.1.0</td>
       <td align="left">
        The default value for <i><tt class="parameter">type</tt></i> was changed from
        <b><tt>PHP_NORMAL_READ</tt></b> to
        <b><tt>PHP_BINARY_READ</tt></b>
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.socket-read-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.socket-accept.html" class="function" rel="rdfs-seeAlso">socket_accept()</a> - Accepts a connection on a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-bind.html" class="function" rel="rdfs-seeAlso">socket_bind()</a> - Binds a name to a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-connect.html" class="function" rel="rdfs-seeAlso">socket_connect()</a> - Initiates a connection on a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-listen.html" class="function" rel="rdfs-seeAlso">socket_listen()</a> - Listens for a connection on a socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-last-error.html" class="function" rel="rdfs-seeAlso">socket_last_error()</a> - Returns the last error on the socket</span></li>
    <li class="member"><span class="function"><a href="function.socket-strerror.html" class="function" rel="rdfs-seeAlso">socket_strerror()</a> - Return a string describing a socket error</span></li>
    <li class="member"><span class="function"><a href="function.socket-write.html" class="function" rel="rdfs-seeAlso">socket_write()</a> - Write to a socket</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="103154""></a>
  <div class="note">
   <strong class="user">eng.mrkto.com</strong>
   <a href="#103154" class="date">29-Mar-2011 04:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems like in socket_* functions in BLOCKING mode where is no way to check if more than $length bytes are still available in socket (like stream_get_meta_data()['unread_bytes']).<br />
So you need to choose your prefered maximum $length (like 133693415:) or use non-blocking mode (for realy big data reciving).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100596""></a>
  <div class="note">
   <strong class="user">hamishcool3 at yahoo dot co dot uk</strong>
   <a href="#100596" class="date">25-Oct-2010 03:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A couple of things:<br />
<br />
The maximum amount that can be read by socket_read is, I think, 133693415 bytes, from my experimentation.<br />
<br />
Also, here is a quick function if anyone wants to read indefinitely until a certain character is sent:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">socket_read_normal</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$end</span><span class="keyword">=array(</span><span class="string">"\r"</span><span class="keyword">, </span><span class="string">"\n"</span><span class="keyword">)){<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$end</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$end </span><span class="keyword">as </span><span class="default">$k</span><span class="keyword">=&gt;</span><span class="default">$v</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$end</span><span class="keyword">[</span><span class="default">$k</span><span class="keyword">]=</span><span class="default">$v</span><span class="keyword">{</span><span class="default">0</span><span class="keyword">};<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">TRUE</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char</span><span class="keyword">=</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string</span><span class="keyword">.=</span><span class="default">$char</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$end </span><span class="keyword">as </span><span class="default">$k</span><span class="keyword">=&gt;</span><span class="default">$v</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$char</span><span class="keyword">==</span><span class="default">$v</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$string</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$endr</span><span class="keyword">=</span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$end</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$try</span><span class="keyword">=</span><span class="default">count</span><span class="keyword">(</span><span class="default">$endr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">TRUE</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ver</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$endr </span><span class="keyword">as </span><span class="default">$k</span><span class="keyword">=&gt;</span><span class="default">$v</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$char</span><span class="keyword">=</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$string</span><span class="keyword">.=</span><span class="default">$char</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$char</span><span class="keyword">==</span><span class="default">$v</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ver</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$ver</span><span class="keyword">==</span><span class="default">$try</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$string</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
You can have either an array of single characters (multi-char values are automatically cut down) or one string. Multiple strings are difficult to do, because you would need to decide which string the current character should 'belong' to (if that makes any sense?) and allow for multiple strings being looked at simultaneously. To put it bluntly, I can't be bothered :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94146""></a>
  <div class="note">
   <strong class="user">philthathril at NOSPAM dot gmail dot com</strong>
   <a href="#94146" class="date">19-Oct-2009 10:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I discovered that socket_read() was not always grabbing the length that I requested. If I requested 1024 bytes, it may return any number smaller than that. Well, due to the nature of network traffic, there's no way to determine how much data will be read from the socket each time. <br />
<br />
To read data of a certain length, this little method works well.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">public function </span><span class="default">readSocketForDataLength </span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socketData </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">$offset </span><span class="keyword">&lt; </span><span class="default">$len</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ((</span><span class="default">$data </span><span class="keyword">= @</span><span class="default">socket_read </span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">-</span><span class="default">$offset</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">readType</span><span class="keyword">)) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">error</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dataLen </span><span class="keyword">= </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">$dataLen</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$socketData </span><span class="keyword">.= </span><span class="default">$data</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$dataLen </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) { break; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$socketData</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Happy coding!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90606""></a>
  <div class="note">
   <strong class="user">p dot hannay at ecu dot edu dot au</strong>
   <a href="#90606" class="date">29-Apr-2009 09:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a quick example of how to use socket_read to receive data until the connection is terminated.<br />
<br />
I've found this useful when I need to manually retrieve replies to XML-RPC queries.<br />
<br />
<span class="default">&lt;?php<br />
$reply </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
do {<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="string">'1400'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; if(</span><span class="default">$recv </span><span class="keyword">!= </span><span class="string">""</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$reply </span><span class="keyword">.= </span><span class="default">$recv</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; }<br />
} while(</span><span class="default">$recv </span><span class="keyword">!= </span><span class="string">""</span><span class="keyword">);<br />
<br />
echo(</span><span class="default">$reply</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89133""></a>
  <div class="note">
   <strong class="user">t33th4n at gmail dot com</strong>
   <a href="#89133" class="date">23-Feb-2009 12:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I don't know if is it stated anywhere with this clearance, but here is the source code for detecting the connection abort/closure for sockets testing with socket_read function:<br />
<br />
<span class="default">&lt;?php<br />
$buf </span><span class="keyword">= @</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$routes</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="default">$connectionid</span><span class="keyword">][</span><span class="string">'tunnelsrc'</span><span class="keyword">], </span><span class="default">$buffer_size</span><span class="keyword">);<br />
if (</span><span class="default">$buf </span><span class="keyword">=== </span><span class="string">''</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$routes</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="default">$connectionid</span><span class="keyword">][</span><span class="string">'disconnected'</span><span class="keyword">]=</span><span class="string">'Conenction abort at source side'</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
($buf === '') is the key :)<br />
<br />
I was making an ecrypted tunnel script with mcrypt and was annoying that i could not detect the connection abort from any side.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84169""></a>
  <div class="note">
   <strong class="user">tech [{at}] swatcash [{dot}] com</strong>
   <a href="#84169" class="date">01-Jul-2008 04:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Messed up the end of my previous one. Corrected version here: <br />
<br />
a simple work around to non-blocking working with normal read is like so:<br />
<br />
$read = array($socket);<br />
$write&nbsp; = NULL;<br />
$except = NULL;<br />
while(1) {<br />
&nbsp;&nbsp;&nbsp; $num_changed_sockets = socket_select($read, $write, $except, 0, 1);<br />
&nbsp;&nbsp;&nbsp; if ( $num_changed_sockets &gt; '0' ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; socket_read($socket,10000,PHP_NORMAL_READ);<br />
&nbsp;&nbsp;&nbsp; } <br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79853""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#79853" class="date">15-Dec-2007 11:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On non-blocking connections it may not return full length requested.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79314""></a>
  <div class="note">
   <strong class="user">nad0r1 at hush dot ai</strong>
   <a href="#79314" class="date">20-Nov-2007 07:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Another way to bypass the annoying thing with telnet, that send each character as a string ,is to check if the response is "\r\n", that is the string that telnet sends when the user presses enter.<br />
<br />
Here is an example:<br />
<span class="default">&lt;?php<br />
error_reporting</span><span class="keyword">(</span><span class="default">E_ALL</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Allow the script to hang around waiting for connections. */<br />
</span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Turn on implicit output flushing so we see what we're getting<br />
&nbsp;* as it comes in. */<br />
</span><span class="default">ob_implicit_flush</span><span class="keyword">();<br />
<br />
</span><span class="default">$address </span><span class="keyword">= </span><span class="string">'127.0.0.1'</span><span class="keyword">;<br />
</span><span class="default">$port </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />
<br />
if ((</span><span class="default">$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">)) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"socket_create() failed: reason: " </span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">()) . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
<br />
if (</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$address</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"socket_bind() failed: reason: " </span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">)) . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
else <br />
&nbsp; echo </span><span class="string">'Socket ' </span><span class="keyword">. </span><span class="default">$address </span><span class="keyword">. </span><span class="string">':' </span><span class="keyword">. </span><span class="default">$port </span><span class="keyword">. </span><span class="string">" has been opened\n"</span><span class="keyword">;<br />
<br />
if (</span><span class="default">socket_listen</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">5</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"socket_listen() failed: reason: " </span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">)) . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
else <br />
&nbsp;&nbsp; echo </span><span class="string">"Listening for new clients..\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; </span><span class="default">$client_id </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
do {<br />
&nbsp;&nbsp;&nbsp; if ((</span><span class="default">$msgsock </span><span class="keyword">= </span><span class="default">socket_accept</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">)) === </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"socket_accept() failed: reason: " </span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">)) . </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$client_id </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; echo </span><span class="string">"Client #" </span><span class="keyword">.</span><span class="default">$client_id </span><span class="keyword">.</span><span class="string">": Connect\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Send instructions. */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="string">"\nWelcome to the PHP Test Server. \n" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"To quit, type 'quit'. To shut down the server type 'shutdown'.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">, </span><span class="default">$msg</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">));<br />
</span><span class="default">$cur_buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">=== (</span><span class="default">$buf </span><span class="keyword">= </span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">, </span><span class="default">2048</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"socket_read() failed: reason: " </span><span class="keyword">. </span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">)) . </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$buf </span><span class="keyword">== </span><span class="string">"\r\n"</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$cur_buf </span><span class="keyword">== </span><span class="string">'quit'</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">'Client #' </span><span class="keyword">.</span><span class="default">$client_id </span><span class="keyword">.</span><span class="string">': Disconnect' </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$cur_buf </span><span class="keyword">== </span><span class="string">'shutdown'</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$talkback </span><span class="keyword">= </span><span class="string">"Unknown command: " </span><span class="keyword">. </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">"\r\n"</span><span class="keyword">, </span><span class="string">'\r\n'</span><span class="keyword">, </span><span class="default">$cur_buf</span><span class="keyword">) .</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">, </span><span class="default">$talkback</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$talkback</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">// }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'Client #' </span><span class="keyword">.</span><span class="default">$client_id </span><span class="keyword">.</span><span class="string">': ' </span><span class="keyword">. </span><span class="default">$cur_buf </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cur_buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else </span><span class="default">$cur_buf </span><span class="keyword">.= </span><span class="default">$buf</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } while (</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$msgsock</span><span class="keyword">);<br />
} while (</span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76470""></a>
  <div class="note">
   <strong class="user">jgbustos at gmail dot com</strong>
   <a href="#76470" class="date">17-Jul-2007 05:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP on win32 developers, please look at this bug report before using the PHP_NORMAL_READ option:<br />
<br />
<a href="http://bugs.php.net/bug.php?id=21197" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=21197</a><br />
<br />
In a nutshell, using PHP_NORMAL_READ will make your calls to socket_read() return an empty buffer every time.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76069""></a>
  <div class="note">
   <strong class="user">ein at anti-logic dot com</strong>
   <a href="#76069" class="date">28-Jun-2007 11:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
the proper way to detect a closed connection is to check socket_last_error.<br />
<br />
Connection reset by peer is 104 (either use socket_strerror or don't suppress errors for the time being to find these out), sooo.<br />
<br />
while($buffer=@socket_read($sock,512,PHP_NORMAL_READ)){<br />
&nbsp;&nbsp;&nbsp; echo $buffer;<br />
}<br />
if(socket_last_error($sock) == 104) {<br />
&nbsp;&nbsp;&nbsp; echo "Connection closed";<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75747""></a>
  <div class="note">
   <strong class="user">nuitari-php at nuitari dot net</strong>
   <a href="#75747" class="date">13-Jun-2007 11:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP_NORMAL_READ - reading stops at \n or \r.<br />
<br />
This seems to be meant literally.<br />
If there is a \r, then it will stop reading, even if there is a \n right after it. You have to call the read again just to get rid of the \n.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73509""></a>
  <div class="note">
   <strong class="user">florin[at nospam]flachi[nospam dot]net</strong>
   <a href="#73509" class="date">26-Feb-2007 04:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello,<br />
<br />
Here is a working solution for using socket_read in nonblocking mode for PHP_NORMAL_MODE read type, as it has some problems in standard PHP.<br />
<br />
The function socket_normal_read will read from an unlimited number of sockets in PHP_NORMAL_MODE read type.<br />
<br />
If you plan to use this function for an application that uses a lot of sockets that are always opening and closing, you might want to improve it to delete the respective records from $sockets and $queues static variables when you close a socket that you will not use anymore.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; define </span><span class="keyword">(</span><span class="string">"LINE_END"</span><span class="keyword">, </span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">socket_normal_read </span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$length</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$sockets </span><span class="keyword">= array ();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$queues </span><span class="keyword">= array ();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; static </span><span class="default">$sock_num </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;&nbsp; isset (</span><span class="default">$sockets</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) &amp;&amp; </span><span class="default">$socket </span><span class="keyword">!= </span><span class="default">$sockets</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]; </span><span class="default">$i</span><span class="keyword">++);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset (</span><span class="default">$sockets</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sockets </span><span class="keyword">[</span><span class="default">$sock_num</span><span class="keyword">] = </span><span class="default">$socket</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$queues </span><span class="keyword">[</span><span class="default">$sock_num</span><span class="keyword">++] = </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="default">socket_read </span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$length</span><span class="keyword">, </span><span class="default">PHP_BINARY_READ</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$recv </span><span class="keyword">=== </span><span class="string">""</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strpos </span><span class="keyword">(</span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">LINE_END</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else if (</span><span class="default">$recv </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] .= </span><span class="default">$recv</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pos </span><span class="keyword">= </span><span class="default">strpos </span><span class="keyword">(</span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">LINE_END</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$pos </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">substr </span><span class="keyword">(</span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">, </span><span class="default">$pos</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">substr </span><span class="keyword">(</span><span class="default">$queues</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$pos</span><span class="keyword">+</span><span class="default">2</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$ret</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sock1 </span><span class="keyword">= </span><span class="default">socket_create </span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sock2 </span><span class="keyword">= </span><span class="default">socket_create </span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sock3 </span><span class="keyword">= </span><span class="default">socket_create </span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sock4 </span><span class="keyword">= </span><span class="default">socket_create </span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect </span><span class="keyword">(</span><span class="default">$sock1</span><span class="keyword">, </span><span class="string">"127.0.0.1"</span><span class="keyword">, </span><span class="default">4551</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect </span><span class="keyword">(</span><span class="default">$sock2</span><span class="keyword">, </span><span class="string">"127.0.0.1"</span><span class="keyword">, </span><span class="default">4552</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect </span><span class="keyword">(</span><span class="default">$sock3</span><span class="keyword">, </span><span class="string">"127.0.0.1"</span><span class="keyword">, </span><span class="default">4553</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect </span><span class="keyword">(</span><span class="default">$sock4</span><span class="keyword">, </span><span class="string">"127.0.0.1"</span><span class="keyword">, </span><span class="default">4554</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_nonblock </span><span class="keyword">(</span><span class="default">$sock1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_nonblock </span><span class="keyword">(</span><span class="default">$sock2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_nonblock </span><span class="keyword">(</span><span class="default">$sock3</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_nonblock </span><span class="keyword">(</span><span class="default">$sock4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep </span><span class="keyword">(</span><span class="default">1000000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">= </span><span class="default">socket_normal_read </span><span class="keyword">(</span><span class="default">$sock1</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$x </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">&amp;&amp; </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"1: </span><span class="default">$x</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">= </span><span class="default">socket_normal_read </span><span class="keyword">(</span><span class="default">$sock2</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$x </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">&amp;&amp; </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"2: </span><span class="default">$x</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">= </span><span class="default">socket_normal_read </span><span class="keyword">(</span><span class="default">$sock3</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$x </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">&amp;&amp; </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"3: </span><span class="default">$x</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x </span><span class="keyword">= </span><span class="default">socket_normal_read </span><span class="keyword">(</span><span class="default">$sock4</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$x </span><span class="keyword">!== </span><span class="default">false </span><span class="keyword">&amp;&amp; </span><span class="default">strlen </span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"4: </span><span class="default">$x</span><span class="string">\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
To test this simple application, just use netcat (nc -vv -l 127.0.0.1 455x) to open 4 listening sockets. After you run this script, write some lines in each of those netcat sessions.<br />
<br />
I hope this will help people that tried to use test-based socket connections in PHP using the sockets library.<br />
<br />
I wait for feedback at the address specified.<br />
<br />
Thank you.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72922""></a>
  <div class="note">
   <strong class="user">dotpointer</strong>
   <a href="#72922" class="date">04-Feb-2007 03:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP 5.2.0 / Win32 / Apache 1.3 - It seems like...<br />
<br />
PHP_BINARY_READ - works, but returns '', not FALSE...<br />
- is blocking, until data received or connection closed<br />
- does pass-through \r\n etc.<br />
- returns data on data, '' on connection closed<br />
- you can detect closed connection by checking for '' (not FALSE as stated i manual)<br />
<br />
PHP_NORMAL_READ - not working so good...<br />
- is non-blocking<br />
- does not pass-through \r\n etc.<br />
- returns false on no-data, false on connection closed :(<br />
- (no way here to detect a closed connection...?)<br />
- (is this a bug? <a href="http://bugs.php.net/bug.php?id=21880 " rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=21880 </a>)<br />
- (is this a bug? <a href="http://bugs.php.net/bug.php?id=21197 " rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=21197 </a>)<br />
- (could not get data from this option at all in fact...)<br />
<br />
PHP_BINARY_READ seems to be the "right way to go" <br />
for now. Both checking for '' and false to detect closed <br />
connection is probably smart, as this "bug"(?) may <br />
be fixed...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69039""></a>
  <div class="note">
   <strong class="user">Niels laukens</strong>
   <a href="#69039" class="date">21-Aug-2006 12:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This paragraph is confusing:<br />
<br />
socket_read() returns the data as a string on success, or FALSE on error (including if the remote host has closed the connection). The error code can be retrieved with socket_last_error(). This code may be passed to socket_strerror() to get a textual representation of the error.<br />
Note: socket_read() returns a zero length string ("") when there is no more data to read.<br />
<br />
My tests (on PHP 5.1.4) show that when you socket_read() on a shutdown-socket, it returns FALSE when using PHP_NORMAL_READ, but returns "" when reading in PHP_BINARY_READ.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68815""></a>
  <div class="note">
   <strong class="user">sbasurto at yahoo dot com</strong>
   <a href="#68815" class="date">11-Aug-2006 11:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Interesting use of sockets:<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//Use sockets and xml coool!!!<br />
//Check this out<br />
/*<br />
//============================================================<br />
//First you create a xsl template like the following called test.xsl:<br />
&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;<br />
&lt;xsl:stylesheet version="1.0" xmlns:xsl="<a href="http://www.w3.org/1999/XSL/Transform" rel="nofollow" target="_blank">http://www.w3.org/1999/XSL/Transform</a>"&gt;<br />
&lt;xsl:output method="html" encoding="iso-8859-1"/&gt;<br />
&lt;xsl:template match="/"&gt;<br />
&lt;table&gt;<br />
&lt;tr&gt;&lt;td&gt;&lt;font color='red'&gt;&lt;xsl:value-of select="test/one"/&gt;&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;<br />
&lt;tr&gt;&lt;td&gt;&lt;font color='blue'&gt;&lt;xsl:value-of select="test/two"/&gt;&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;<br />
&lt;/table&gt;<br />
&lt;/xsl:template&gt;<br />
&lt;/xsl:stylesheet&gt;<br />
//============================================================<br />
*/<br />
//============================================================<br />
//Second: You create a php script called getResponse.php with the following content:<br />
<br />
</span><span class="keyword">echo </span><span class="default">chr</span><span class="keyword">(</span><span class="default">60</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">63</span><span class="keyword">).</span><span class="string">"xml version"</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">61</span><span class="keyword">).</span><span class="string">"\"1.0\" encoding"</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">61</span><span class="keyword">).</span><span class="string">"\"ISO"</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">45</span><span class="keyword">).</span><span class="string">"8859"</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">45</span><span class="keyword">).</span><span class="string">"1\" standalone"</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">61</span><span class="keyword">).</span><span class="string">"\"yes\" "</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">63</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">62</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
...</span><span class="default">connect to a database postgres</span><span class="keyword">...<br />
</span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"select first, second from my_table;"</span><span class="keyword">;<br />
...</span><span class="default">execute the query </span><span class="keyword">and </span><span class="default">asign to $result </span><span class="keyword">array...<br />
<br />
</span><span class="default">$xml_string </span><span class="keyword">= </span><span class="string">"&lt;test&gt;\n"</span><span class="keyword">;<br />
while(</span><span class="default">$result</span><span class="keyword">){&nbsp; <br />
&nbsp; </span><span class="default">$xml_string </span><span class="keyword">.= </span><span class="string">"&lt;one&gt;"</span><span class="keyword">.</span><span class="default">$result</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'first'</span><span class="keyword">].</span><span class="string">"&lt;/one&gt;\n"</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$xml_string </span><span class="keyword">.= </span><span class="string">"&lt;two&gt;"</span><span class="keyword">.</span><span class="default">$result</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'second'</span><span class="keyword">].</span><span class="string">"&lt;/two&gt;\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">$xml_string </span><span class="keyword">.= </span><span class="string">"&lt;/test&gt;\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Expires: Mon, 26 Jul 1997 05:00:00 GMT"</span><span class="keyword">); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Last-Modified: " </span><span class="keyword">. </span><span class="default">gmdate</span><span class="keyword">(</span><span class="string">"D, d M Y H:i:s"</span><span class="keyword">) . </span><span class="string">" GMT"</span><span class="keyword">); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Cache-Control: no-store, no-cache, must-revalidate"</span><span class="keyword">); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Cache-Control: post-check=0, pre-check=0"</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Pragma: no-cache"</span><span class="keyword">); <br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type:text/xml"</span><span class="keyword">);<br />
echo </span><span class="default">$xml_string</span><span class="keyword">;<br />
</span><span class="comment">//============================================================<br />
<br />
//==================S O C K E T S===============================<br />
//Finally: Create a php script called master.php with the following content.<br />
</span><span class="default">$server </span><span class="keyword">= </span><span class="string">"192.168.0.1"</span><span class="keyword">; </span><span class="comment">//my server<br />
</span><span class="default">$sk </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">SOL_TCP</span><span class="keyword">);<br />
</span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$sk</span><span class="keyword">, </span><span class="default">$server</span><span class="keyword">, </span><span class="default">80</span><span class="keyword">);<br />
</span><span class="default">$request </span><span class="keyword">= </span><span class="string">"GET /getResponse.php HTTP/1.0"</span><span class="keyword">.</span><span class="string">"\r\n"</span><span class="keyword">;<br />
</span><span class="default">$request </span><span class="keyword">.= </span><span class="string">"Host:192.168.0.1 \r\n\r\n"</span><span class="keyword">;<br />
</span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$sk</span><span class="keyword">, </span><span class="default">$request</span><span class="keyword">);<br />
<br />
</span><span class="default">$doc </span><span class="keyword">= new </span><span class="default">DOMDocument</span><span class="keyword">();<br />
</span><span class="default">$xsl </span><span class="keyword">= new </span><span class="default">XSLTProcessor</span><span class="keyword">();<br />
</span><span class="default">$doc</span><span class="keyword">-&gt;</span><span class="default">load</span><span class="keyword">(</span><span class="string">"./test.xsl"</span><span class="keyword">);<br />
</span><span class="default">$xsl</span><span class="keyword">-&gt;</span><span class="default">importStyleSheet</span><span class="keyword">(</span><span class="default">$doc</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">$doc</span><span class="keyword">-&gt;</span><span class="default">loadXML</span><span class="keyword">(</span><span class="default">strstr</span><span class="keyword">(</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$sk</span><span class="keyword">,</span><span class="default">12000</span><span class="keyword">),</span><span class="string">"&lt;?xml"</span><span class="keyword">));<br />
echo </span><span class="default">$xsl</span><span class="keyword">-&gt;</span><span class="default">transformToXML</span><span class="keyword">(</span><span class="default">$doc</span><span class="keyword">);<br />
</span><span class="comment">//==================S O C K E T S================================<br />
<br />
</span><span class="string">"The output is the result of the query one line red and one blue"</span><span class="keyword">.<br />
<br />
</span><span class="comment">//The most interesting thing here, is that you can create all the<br />
//pages of your site with one xsl template and xml, but with <br />
//the advantage of using the power of PHP.<br />
//cool isn't it?<br />
<br />
</span><span class="default">Regards bazz</span><span class="keyword">.<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65524""></a>
  <div class="note">
   <strong class="user">Ronin-php at onabout dot net</strong>
   <a href="#65524" class="date">02-May-2006 12:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a helper for those trying to use sockets to transfer large ammounts of info.<br />
<br />
I was pulling my hair out forever trying to figure out why different strings sent by different socket_writes were getting concatenated by socket_read.<br />
<br />
If you have a problem with this, try a sleep(), the delay allows the server to see the difference (it is able to do one before the next arrives)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51063""></a>
  <div class="note">
   <strong class="user">Bill Kuker</strong>
   <a href="#51063" class="date">18-Mar-2005 07:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a note that on my system the length seems to have an undocumented upper bound of 65536. I was being lazy and not read()ing in a while loop until I pointed it at real data ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42700""></a>
  <div class="note">
   <strong class="user">michi at tr51 dot org</strong>
   <a href="#42700" class="date">26-May-2004 12:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you'd like to make a "socket_read" on a linux-system connected with a flash-client (v. 6.0 r81) you have to send a string to the connected port:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp; </span><span class="keyword">...&nbsp; </span><span class="comment">//initialising communication<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="string">"ready to get/send data\0"</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_write</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//now you can read from...<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">(</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">MAXLINE</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; ...&nbsp; </span><span class="comment">// do some stuff, finaly close connection<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35416""></a>
  <div class="note">
   <strong class="user">magicking89 at hotmail dot com</strong>
   <a href="#35416" class="date">30-Aug-2003 04:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you want to use a non block socket you must to use socket_last_error<br />
<br />
if(!socket_last_error($sc)){<br />
&nbsp;&nbsp; if($buffer=socket_read($sc,512,PHP_NORMAL_READ)){<br />
&nbsp;&nbsp; &nbsp;&nbsp; echo $buffer;<br />
&nbsp;&nbsp; }<br />
}<br />
<br />
if you use it your script wont take all your memory</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="33719""></a>
  <div class="note">
   <strong class="user">schst at php-tools dot de</strong>
   <a href="#33719" class="date">04-Jul-2003 06:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You may download a generic server class at <a href="http://www.php-tools.de" rel="nofollow" target="_blank">http://www.php-tools.de</a><br />
This class will accept the sockets read data from it and hands it to a callback function. Furthermore there are methods for connection handling included.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25456""></a>
  <div class="note">
   
   <a href="#25456" class="date">24-Sep-2002 11:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Windows telnet sends/recieves one character at a time. Try adding PHP_NORMAL_READ to the end of socket_read, that might help.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.socket-listen.html">socket_listen</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.socket-recv.html">socket_recv</a></div>
 <div class="up"><a href="ref.sockets.html">Socket Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
