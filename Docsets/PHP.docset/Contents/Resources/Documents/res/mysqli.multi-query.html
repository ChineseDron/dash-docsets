<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Performs a query on the database</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.more-results.html">mysqli::more_results</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.next-result.html">mysqli::next_result</a></div>
 <div class="up"><a href="class.mysqli.html">mysqli</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqli.multi-query" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqli::multi_query</h1>
  <h1 class="refname">mysqli_multi_query</h1>
  <p class="verinfo">(PHP 5)</p><p class="refpurpose"><span class="refname">mysqli::multi_query</span> -- <span class="refname">mysqli_multi_query</span> &mdash; <span class="dc-title">Performs a query on the database</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mysqli.multi-query-description">
  <h3 class="title">Description</h3>
  <p class="para">Object oriented style</p>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>mysqli::multi_query</b></span>
    ( <span class="methodparam"><span class="type">string</span> <tt class="parameter">$query</tt></span>
   )</div>

  <p class="para rdfs-comment">Procedural style</p>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>mysqli_multi_query</b></span>
    ( <span class="methodparam"><span class="type"><a href="class.mysqli.html" class="type mysqli">mysqli</a></span> <tt class="parameter">$link</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$query</tt></span>
   )</div>

  <p class="para rdfs-comment">
   Executes one or multiple queries which are concatenated by a semicolon.
  </p>
  <p class="para">
   To retrieve the resultset from the first query you can use
   <span class="function"><a href="mysqli.use-result.html" class="function">mysqli_use_result()</a></span> or <span class="function"><a href="mysqli.store-result.html" class="function">mysqli_store_result()</a></span>.
   All subsequent query results can be processed using
   <span class="function"><a href="mysqli.more-results.html" class="function">mysqli_more_results()</a></span> and <span class="function"><a href="mysqli.next-result.html" class="function">mysqli_next_result()</a></span>.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-mysqli.multi-query-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>
<span class="term"><i><tt class="parameter">
link</tt></i></span><dd>
<p class="para">Procedural style only: A link identifier
returned by <span class="function"><a href="function.mysqli-connect.html" class="function">mysqli_connect()</a></span> or <span class="function"><a href="mysqli.init.html" class="function">mysqli_init()</a></span>
</p></dd>
</dt>

    <dt>

     <span class="term"><i><tt class="parameter">query</tt></i></span>
     <dd>

      <p class="para">
       The query, as a string.
      </p>
      <p class="para">
       Data inside the query should be <a href="mysqli.real-escape-string.html" class="link">properly escaped</a>.
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mysqli.multi-query-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>FALSE</tt></b> if the first statement failed.
   To retrieve subsequent errors from other statements you have to call
   <span class="function"><a href="mysqli.next-result.html" class="function">mysqli_next_result()</a></span> first.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mysqli.multi-query-examples">
  <h3 class="title">Examples</h3>
  <div class="example" id="example-1605">
   <p><b>Example #1  <span class="methodname"><b>mysqli::multi_query()</b></span> example</b></p>
   <div class="example-contents"><p>Object oriented style</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;check&nbsp;connection&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">$query&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;CURRENT_USER();"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$query&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;Name&nbsp;FROM&nbsp;City&nbsp;ORDER&nbsp;BY&nbsp;ID&nbsp;LIMIT&nbsp;20,&nbsp;5"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;execute&nbsp;multi&nbsp;query&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">multi_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;store&nbsp;first&nbsp;result&nbsp;set&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">store_result</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_row</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;print&nbsp;divider&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">more_results</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"-----------------\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">next_result</span><span style="color: #007700">());<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;close&nbsp;connection&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>Procedural style</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;check&nbsp;connection&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">$query&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;CURRENT_USER();"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$query&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;Name&nbsp;FROM&nbsp;City&nbsp;ORDER&nbsp;BY&nbsp;ID&nbsp;LIMIT&nbsp;20,&nbsp;5"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;execute&nbsp;multi&nbsp;query&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_multi_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;store&nbsp;first&nbsp;result&nbsp;set&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_store_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_fetch_row</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_free_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;print&nbsp;divider&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_more_results</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"-----------------\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(</span><span style="color: #0000BB">mysqli_next_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">));<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;close&nbsp;connection&nbsp;*/<br /></span><span style="color: #0000BB">mysqli_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>The above examples will output
something similar to:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
my_user@localhost
-----------------
Amersfoort
Maastricht
Dordrecht
Leiden
Haarlemmermeer
</pre></div>
   </div>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mysqli.multi-query-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="mysqli.use-result.html" class="function" rel="rdfs-seeAlso">mysqli_use_result()</a> - Initiate a result set retrieval</span></li>
    <li class="member"><span class="function"><a href="mysqli.store-result.html" class="function" rel="rdfs-seeAlso">mysqli_store_result()</a> - Transfers a result set from the last query</span></li>
    <li class="member"><span class="function"><a href="mysqli.next-result.html" class="function" rel="rdfs-seeAlso">mysqli_next_result()</a> - Prepare next result from multi_query</span></li>
    <li class="member"><span class="function"><a href="mysqli.more-results.html" class="function" rel="rdfs-seeAlso">mysqli_more_results()</a> - Check if there are any more query results from a multi query</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="106126""></a>
  <div class="note">
   <strong class="user">crmccar at gmail dot com</strong>
   <a href="#106126" class="date">12-Oct-2011 06:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'd like to reinforce the correct way of catching errors from the queries executed by multi_query(), since the manual's examples don't show it and it's easy to lose UPDATEs, INSERTs, etc. without knowing it.<br />
<br />
$mysqli-&gt;next_result() will return false if it runs out of statements OR if the next statement has an error. Therefore, it's important to check for errors when the loop ends. Also, I believe it's useful to know when and where the loop broke, so consider the following code:<br />
<br />
<span class="default">&lt;?php<br />
$statements </span><span class="keyword">= array(</span><span class="string">"INSERT INTO tablename VALUES ('1', 'one')"</span><span class="keyword">, </span><span class="string">"INSERT INTO tablename VALUES ('2', 'two')"</span><span class="keyword">);<br />
if (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">multi_query</span><span class="keyword">(</span><span class="default">implode</span><span class="keyword">(</span><span class="string">';'</span><span class="keyword">, </span><span class="default">$statements</span><span class="keyword">))) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp;&nbsp; } while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
}<br />
if (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">errno</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Batch execution prematurely ended on statement </span><span class="default">$i</span><span class="string">.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$statements</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">error</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
The IF statement on the multi_query() call checks the first result, because next_result() starts at the second.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105579""></a>
  <div class="note">
   <strong class="user">lcruz at humansoft dot pt</strong>
   <a href="#105579" class="date">29-Aug-2011 02:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that MySQL does not support Transactions on DDL statements.<br />
<br />
<span class="default">&lt;?php<br />
$link </span><span class="keyword">= </span><span class="default">mysqli_connect</span><span class="keyword">(</span><span class="string">'localhost'</span><span class="keyword">, </span><span class="string">'user'</span><span class="keyword">, </span><span class="string">'pw'</span><span class="keyword">, </span><span class="string">'db'</span><span class="keyword">);<br />
<br />
</span><span class="default">$script </span><span class="keyword">= </span><span class="string">"INSERT INTO T1('pk', 'val') VALUES('1', 'A');"</span><span class="keyword">;<br />
</span><span class="default">$script </span><span class="keyword">.= </span><span class="string">"INSERT INTO T1('pk', 'val') VALUES('2', 'B');"<br />
</span><span class="default">$script </span><span class="keyword">.= </span><span class="string">"INSERT INTO T1('pk', 'val') VALUES('3', 'C');"<br />
</span><span class="default">$script </span><span class="keyword">.= </span><span class="string">"ALTER TABLE T1 ADD COLUMN `foo` INT(1) NOT NULL;"</span><span class="keyword">;<br />
</span><span class="default">$script </span><span class="keyword">.= </span><span class="string">"UPDATE T1 SET val = 'D' where pkkkkkkkkkkkk = '1'"</span><span class="keyword">; </span><span class="comment">// Note that this statement will force a SQL Error since column pkkkkkkkkkkkk doesn't exist<br />
<br />
</span><span class="default">mysqli_autocommit</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">); </span><span class="comment">// set autocommit to false<br />
<br />
</span><span class="default">mysqli_multi_query</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$script</span><span class="keyword">); </span><span class="comment">// execute statements<br />
<br />
</span><span class="default">mysqli_rollback</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">); </span><span class="comment">// rollback all statements<br />
</span><span class="default">?&gt;<br />
</span><br />
I would expect that the entire set of statements would not occur since the last update would generate an error. However after the code execution you'll see the values on table T1. <br />
<br />
I've spent a couple of days to find that this behavior is normal in MySQL since the ALTER TABLE statement automatically commits the transaction. See more in <a href="http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html" rel="nofollow" target="_blank">http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104076""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#104076" class="date">20-May-2011 07:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your second or late query returns no result or even if your query is not a valid SQL query, more_results(); returns true in any case.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102837""></a>
  <div class="note">
   <strong class="user">jcn50</strong>
   <a href="#102837" class="date">09-Mar-2011 05:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
WATCH OUT: if you mix $mysqli-&gt;multi_query and $mysqli-&gt;query, the latter(s) won't be executed!<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// BAD CODE:<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">multi_query</span><span class="keyword">(</span><span class="string">" Many SQL queries ; "</span><span class="keyword">); </span><span class="comment">// OK<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #1 ; "</span><span class="keyword">) </span><span class="comment">// not executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #2 ; "</span><span class="keyword">) </span><span class="comment">// not executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #3 ; "</span><span class="keyword">) </span><span class="comment">// not executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #4 ; "</span><span class="keyword">) </span><span class="comment">// not executed!<br />
</span><span class="default">?&gt;<br />
</span><br />
The only way to do this correctly is:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// WORKING CODE:<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">multi_query</span><span class="keyword">(</span><span class="string">" Many SQL queries ; "</span><span class="keyword">); </span><span class="comment">// OK<br />
</span><span class="keyword">while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">()) {;} </span><span class="comment">// flush multi_queries<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #1 ; "</span><span class="keyword">) </span><span class="comment">// now executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #2 ; "</span><span class="keyword">) </span><span class="comment">// now executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #3 ; "</span><span class="keyword">) </span><span class="comment">// now executed!<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">" SQL statement #4 ; "</span><span class="keyword">) </span><span class="comment">// now executed!<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100018""></a>
  <div class="note">
   <strong class="user">luka8088 at owave dot net</strong>
   <a href="#100018" class="date">20-Sep-2010 10:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you don't iterate through all results you get "server has gone away" error message ...<br />
<br />
to resolve this, in php 5.2 it is enough to use<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="comment">// ok for php 5.2<br />
&nbsp; </span><span class="keyword">while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
</span><span class="default">?&gt;<br />
</span><br />
to drop unwanted results, but in php 5.3 using only this throws<br />
<br />
mysqli::next_result(): There is no next result set. Please, call mysqli_more_results()/mysqli::more_results() to check whether to call this function/method<br />
<br />
so it should be replaced with<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="comment">// ok for php 5.3<br />
&nbsp; </span><span class="keyword">while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">more_results</span><span class="keyword">() &amp;&amp; </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
</span><span class="default">?&gt;<br />
</span><br />
I also tried but failed:<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp; </span><span class="comment">// can create infinite look in some cases<br />
&nbsp; </span><span class="keyword">while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">more_results</span><span class="keyword">())<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
<br />
&nbsp; </span><span class="comment">// also throws error in some cases<br />
&nbsp; </span><span class="keyword">if (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">more_results</span><span class="keyword">())<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97354""></a>
  <div class="note">
   <strong class="user">Shawn Pyle</strong>
   <a href="#97354" class="date">15-Apr-2010 09:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be sure to not send a set of queries that are larger than max_allowed_packet size on your MySQL server. If you do, you'll get an error like: <br />
Mysql Error (1153): Got a packet bigger than 'max_allowed_packet' bytes<br />
<br />
To see your MySQL size limitation, run the following query: show variables like 'max_allowed_packet';<br />
<br />
or see <a href="http://dev.mysql.com/doc/refman/5.1/en/packet-too-large.html" rel="nofollow" target="_blank">http://dev.mysql.com/doc/refman/5.1/en/packet-too-large.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91677""></a>
  <div class="note">
   <strong class="user">Miles</strong>
   <a href="#91677" class="date">22-Jun-2009 10:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can use prepared statements on stored procedures.<br />
<br />
You just need to flush all the subsequent result sets before closing the statement... so:<br />
<br />
$mysqli_stmt = $mysqli-&gt;prepare(....);<br />
<br />
... bind, execute, bind, fetch ...<br />
<br />
while($mysqli-&gt;more_results())<br />
{<br />
&nbsp;&nbsp;&nbsp; $mysqli-&gt;next_result();<br />
&nbsp;&nbsp;&nbsp; $discard = $mysqli-&gt;store_result();<br />
}<br />
<br />
$mysqli_stmt-&gt;close();<br />
<br />
Hope that helps :o)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88562""></a>
  <div class="note">
   <strong class="user">raye1010 at yahoo dot com dot hk</strong>
   <a href="#88562" class="date">28-Jan-2009 10:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is my point of view:<br />
<br />
Actually when calling $mysqli-&gt;next_result(), MySQL server will try to prepare resources for storing resultset. If you want to multi query for stored procedures, it's better to use $mysqli-&gt;use_result()-&gt;close() to close the resources. For functions, it's better to use $mysqli-&gt;store_result()-&gt;free() since there's resultset returned. Otherwise, an error of "Commands out of sync" will be rasied.<br />
<br />
Here's the code I test:<br />
<br />
<span class="default">&lt;?php<br />
$mysql </span><span class="keyword">= new </span><span class="default">mysql</span><span class="keyword">(</span><span class="string">'localhost'</span><span class="keyword">, </span><span class="string">'user'</span><span class="keyword">, </span><span class="string">'pw'</span><span class="keyword">, </span><span class="string">'db'</span><span class="keyword">);<br />
<br />
</span><span class="default">$query </span><span class="keyword">= </span><span class="string">'show tables;'</span><span class="keyword">;<br />
</span><span class="default">$query</span><span class="keyword">.= </span><span class="string">'show tables;'</span><span class="keyword">;<br />
</span><span class="default">$query</span><span class="keyword">.= </span><span class="string">'select * from dummy_table;'</span><span class="keyword">;<br />
</span><span class="default">$query</span><span class="keyword">.= </span><span class="string">'show tables;'</span><span class="keyword">; </span><span class="comment">// this statement will be ignored as the dummy_table doesn't exist and the loop should quit<br />
<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">multi_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
do {<br />
&nbsp; </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">use_result</span><span class="keyword">()-&gt;</span><span class="default">close</span><span class="keyword">();<br />
&nbsp; echo </span><span class="string">"Okay\n"</span><span class="keyword">;<br />
} while (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
<br />
if (</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">errno</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="string">"Stopped while retrieving result : "</span><span class="keyword">.</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">error</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span>Returns :<br />
Okay<br />
Okay<br />
Stopped while retrieving result : Table 'db.dummy_table' doesn't exist</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85370""></a>
  <div class="note">
   <strong class="user">jparedes at gmail dot com</strong>
   <a href="#85370" class="date">27-Aug-2008 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It's very important that after executing mysqli_multi_query you have first process the resultsets before sending any another statement to the server, otherwise your<br />
socket is still blocked.<br />
<br />
Please note that even if your multi statement doesn't contain SELECT queries, the server will send result packages containing errorcodes (or OK packet) for single statements.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81566""></a>
  <div class="note">
   <strong class="user">undefined(AT)users(DOT)berlios(DOT)de</strong>
   <a href="#81566" class="date">04-Mar-2008 04:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mysqli_multi_query handles MySQL Transaction on InnoDB's :-)<br />
<br />
<span class="default">&lt;?php<br />
<br />
$mysqli&nbsp; </span><span class="keyword">= </span><span class="default">mysqli_connect</span><span class="keyword">( </span><span class="string">"localhost"</span><span class="keyword">, </span><span class="string">"owner"</span><span class="keyword">, </span><span class="string">"pass"</span><span class="keyword">, </span><span class="string">"db"</span><span class="keyword">, </span><span class="default">3306</span><span class="keyword">, </span><span class="string">"/var/lib/mysql/mysql.sock" </span><span class="keyword">);<br />
<br />
</span><span class="default">$QUERY </span><span class="keyword">= &lt;&lt;&lt;EOT<br />
</span><span class="string">START TRANSACTION;<br />
SELECT @lng:=IF( STRCMP(`main_lang`,'de'), 'en', 'de' )<br />
FROM `main_data` WHERE&nbsp; ( `main_activ` LIKE 1 ) ORDER BY `main_id` ASC;<br />
SELECT `main_id`, `main_type`, `main_title`, `main_body`, `main_modified`, `main_posted`<br />
FROM `main_data`<br />
WHERE ( `main_type` RLIKE "news|about" AND `main_lang` LIKE @lng AND `main_activ` LIKE 1 )<br />
ORDER BY `main_type` ASC;<br />
COMMIT;<br />
</span><span class="keyword">EOT;<br />
<br />
</span><span class="default">$query </span><span class="keyword">= </span><span class="default">mysqli_multi_query</span><span class="keyword">( </span><span class="default">$mysqli</span><span class="keyword">, </span><span class="default">$QUERY </span><span class="keyword">) or die( </span><span class="default">mysqli_error</span><span class="keyword">( </span><span class="default">$mysqli </span><span class="keyword">) );<br />
<br />
if( </span><span class="default">$query </span><span class="keyword">)<br />
{<br />
&nbsp; do {<br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysqli_store_result</span><span class="keyword">( </span><span class="default">$mysqli </span><span class="keyword">) )<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$subresult </span><span class="keyword">= </span><span class="default">mysqli_fetch_assoc</span><span class="keyword">( </span><span class="default">$result </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; if( ! isset( </span><span class="default">$subresult</span><span class="keyword">[</span><span class="string">'main_id'</span><span class="keyword">] ) )<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; continue;<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; foreach( </span><span class="default">$subresult </span><span class="keyword">AS </span><span class="default">$k </span><span class="keyword">=&gt; </span><span class="default">$v </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">( </span><span class="default">$k </span><span class="keyword">, </span><span class="default">$v </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; } while ( </span><span class="default">mysqli_next_result</span><span class="keyword">( </span><span class="default">$mysqli </span><span class="keyword">) );<br />
}<br />
<br />
</span><span class="default">mysqli_close</span><span class="keyword">( </span><span class="default">$mysqli </span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71465""></a>
  <div class="note">
   <strong class="user">mjmendoza at grupzero dot tk</strong>
   <a href="#71465" class="date">29-Nov-2006 10:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was developing my own CMS and I was having problem with attaching the database' sql file. I thought mysqli_multi_query got bugs where it crashes my MySQL server. I tried to report the bug but it showed that it has duplicate bug reports of other developers. To my surprise, mysqli_multi_query needs to bother with result even if there's none.<br />
<br />
I finally got it working when I copied the sample and removed somethings. Here is what it looked liked<br />
<br />
<span class="default">&lt;?php<br />
$link </span><span class="keyword">= </span><span class="default">mysqli_connect</span><span class="keyword">(</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="string">"my_user"</span><span class="keyword">, </span><span class="string">"my_password"</span><span class="keyword">, </span><span class="string">"world"</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* check connection */<br />
</span><span class="keyword">if (</span><span class="default">mysqli_connect_errno</span><span class="keyword">()) {<br />
&nbsp;&nbsp; </span><span class="default">printf</span><span class="keyword">(</span><span class="string">"Connect failed: %s\n"</span><span class="keyword">, </span><span class="default">mysqli_connect_error</span><span class="keyword">());<br />
&nbsp;&nbsp; exit();<br />
}<br />
<br />
</span><span class="default">$query&nbsp; </span><span class="keyword">= </span><span class="string">"CREATE TABLE....;...;... blah blah blah;..."</span><span class="keyword">;<br />
<br />
</span><span class="comment">/* execute multi query */<br />
</span><span class="keyword">if (</span><span class="default">mysqli_multi_query</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$query</span><span class="keyword">)) {<br />
&nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">/* store first result set */<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysqli_store_result</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//do nothing since there's nothing to handle<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">mysqli_free_result</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">/* print divider */<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">mysqli_more_results</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//I just kept this since it seems useful<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //try removing and see for yourself<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp; } while (</span><span class="default">mysqli_next_result</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">));<br />
}<br />
<br />
</span><span class="comment">/* close connection */<br />
</span><span class="default">mysqli_close</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
bottom-line: I think mysql_multi_query should only be used for attaching a database. it's hard to handle results from 'SELECT' statements inside a single while loop.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69503""></a>
  <div class="note">
   <strong class="user">sly underscore mcfly at hotmail dot com</strong>
   <a href="#69503" class="date">07-Sep-2006 05:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Ive just had exactly the same problem as below trying to execute multiple stored procedures. I thought i might as well add how to do it the object oriented way.<br />
<br />
Instead of putting the one statement:<br />
<br />
<span class="default">&lt;?php<br />
$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
Put two:<br />
<br />
<span class="default">&lt;?php<br />
$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
The first statement points (possibly using the term incorrectly) you to the return value. The second one will point you to the result of the next query.<br />
<br />
I hope this makes sense.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65810""></a>
  <div class="note">
   <strong class="user">info at ff dot net</strong>
   <a href="#65810" class="date">08-May-2006 04:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that you need to use this function to call Stored Procedures!<br />
<br />
If you experience "lost connection to MySQL server" errors with your Stored Procedure calls then you did not fetch the 'OK' (or 'ERR') message, which is a second result-set from a Stored Procedure call. You have to fetch that result to have no problems with subsequent queries.<br />
<br />
Bad example, will FAIL now and then on subsequent calls:<br />
<span class="default">&lt;?php<br />
$sQuery</span><span class="keyword">=</span><span class="string">'CALL exampleSP('</span><span class="default">param</span><span class="string">')'</span><span class="keyword">;<br />
if(!</span><span class="default">mysqli_multi_query</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">,</span><span class="default">$sQuery</span><span class="keyword">))<br />
&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">queryError</span><span class="keyword">();<br />
</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlResult</span><span class="keyword">=</span><span class="default">mysqli_store_result</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Working example:<br />
<span class="default">&lt;?php<br />
$sQuery</span><span class="keyword">=</span><span class="string">'CALL exampleSP('</span><span class="default">param</span><span class="string">')'</span><span class="keyword">;<br />
if(!</span><span class="default">mysqli_multi_query</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">,</span><span class="default">$sQuery</span><span class="keyword">))<br />
&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">queryError</span><span class="keyword">();<br />
</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlResult</span><span class="keyword">=</span><span class="default">mysqli_store_result</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">);<br />
<br />
if(</span><span class="default">mysqli_more_results</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">))<br />
&nbsp; while(</span><span class="default">mysqli_next_result</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">));<br />
</span><span class="default">?&gt;<br />
</span><br />
Of course you can do more with the multiple results then just throwing them away, but for most this will suffice. You could for example make an "sp" function which will kill the 2nd 'ok' result.<br />
<br />
This nasty 'OK'-message made me spend hours trying to figure out why MySQL server was logging warnings with 'bad packets from client' and PHP mysql_error() with 'Connection lost'. It's a shame the mysqli library does catch this by just doing it for you.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.more-results.html">mysqli::more_results</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.next-result.html">mysqli::next_result</a></div>
 <div class="up"><a href="class.mysqli.html">mysqli</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
