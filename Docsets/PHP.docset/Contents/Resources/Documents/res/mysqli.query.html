<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Performs a query on the database</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.prepare.html">mysqli::prepare</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.real-connect.html">mysqli::real_connect</a></div>
 <div class="up"><a href="class.mysqli.html">mysqli</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqli.query" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqli::query</h1>
  <h1 class="refname">mysqli_query</h1>
  <p class="verinfo">(PHP 5)</p><p class="refpurpose"><span class="refname">mysqli::query</span> -- <span class="refname">mysqli_query</span> &mdash; <span class="dc-title">Performs a query on the database</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mysqli.query-description">
  <h3 class="title">Description</h3>
  <p class="para">Object oriented style</p>
  <div class="methodsynopsis dc-description">
   <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <span class="methodname"><b>mysqli::query</b></span>
    ( <span class="methodparam"><span class="type">string</span> <tt class="parameter">$query</tt></span>
   [, <span class="methodparam"><span class="type">int</span> <tt class="parameter">$resultmode</tt><span class="initializer"> = MYSQLI_STORE_RESULT</span></span>
  ] )</div>

  <p class="para rdfs-comment">Procedural style</p>
  <div class="methodsynopsis dc-description">
   <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <span class="methodname"><b>mysqli_query</b></span>
    ( <span class="methodparam"><span class="type"><a href="class.mysqli.html" class="type mysqli">mysqli</a></span> <tt class="parameter">$link</tt></span>
   , <span class="methodparam"><span class="type">string</span> <tt class="parameter">$query</tt></span>
   [, <span class="methodparam"><span class="type">int</span> <tt class="parameter">$resultmode</tt><span class="initializer"> = MYSQLI_STORE_RESULT</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   Performs a <i><tt class="parameter">query</tt></i> against the database.
  </p>
  <p class="para">
   Functionally, using this function is identical to calling 
   <span class="function"><a href="mysqli.real-query.html" class="function">mysqli_real_query()</a></span> followed either by 
   <span class="function"><a href="mysqli.use-result.html" class="function">mysqli_use_result()</a></span> or 
   <span class="function"><a href="mysqli.store-result.html" class="function">mysqli_store_result()</a></span>.
  </p>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <p class="para">
    In the case where you pass a statement to
    <span class="function"><b>mysqli_query()</b></span> that is longer than
    <i>max_allowed_packet</i> of the server, the returned
    error codes are different depending on whether you are using MySQL
    Native Driver (<i>mysqlnd</i>) or MySQL Client Library
    (<i>libmysql</i>). The behavior is as follows:
   </p>
   <ul class="itemizedlist">
    <li class="listitem">
     <p class="para">
      <i>mysqlnd</i> on Linux returns an error code of 1153.
      The error message means "<span class="quote">got a packet bigger than
      <i>max_allowed_packet</i> bytes</span>".
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      <i>mysqlnd</i> on Windows returns an error code 2006.
      This error message means "<span class="quote">server has gone away</span>".
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      <i>libmysql</i> on all platforms returns an error code
      2006. This error message means "<span class="quote">server has gone
      away</span>".
     </p>
    </li>
   </ul>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-mysqli.query-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>
<span class="term"><i><tt class="parameter">
link</tt></i></span><dd>
<p class="para">Procedural style only: A link identifier
returned by <span class="function"><a href="function.mysqli-connect.html" class="function">mysqli_connect()</a></span> or <span class="function"><a href="mysqli.init.html" class="function">mysqli_init()</a></span>
</p></dd>
</dt>

    <dt>

     <span class="term"><i><tt class="parameter">query</tt></i></span>
     <dd>

      <p class="para">
       The query string.
      </p>
      <p class="para">
       Data inside the query should be <a href="mysqli.real-escape-string.html" class="link">properly escaped</a>.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">resultmode</tt></i></span>
     <dd>

      <p class="para">
       Either the constant <b><tt>MYSQLI_USE_RESULT</tt></b> or
       <b><tt>MYSQLI_STORE_RESULT</tt></b> depending on the desired
       behavior. By default, <b><tt>MYSQLI_STORE_RESULT</tt></b> is used.
      </p>
      <p class="para">
       If you use <b><tt>MYSQLI_USE_RESULT</tt></b> all subsequent calls
       will return error <i>Commands out of sync</i> unless you
       call <span class="function"><a href="mysqli-result.free.html" class="function">mysqli_free_result()</a></span>
      </p>
      <p class="para">
       With <b><tt>MYSQLI_ASYNC</tt></b> (available with mysqlnd), it is
       possible to perform query asynchronously.
       <span class="function"><a href="mysqli.poll.html" class="function">mysqli_poll()</a></span> is then used to get results from such
       queries.
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mysqli.query-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>FALSE</tt></b> on failure. For successful <i>SELECT, SHOW, DESCRIBE</i> or
   <i>EXPLAIN</i> queries <span class="function"><b>mysqli_query()</b></span> will return
   a <a href="class.mysqli-result.html" class="classname">mysqli_result</a> object. For other successful queries <span class="function"><b>mysqli_query()</b></span> will
   return <b><tt>TRUE</tt></b>.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-mysqli.query-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead valign="middle">
      <tr valign="middle">
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody valign="middle" class="tbody">
      <tr valign="middle">
       <td align="left">5.3.0</td>
       <td align="left">
        Added the ability of async queries.
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mysqli.query-examples">
  <h3 class="title">Examples</h3>
  <div class="example" id="example-1609">
   <p><b>Example #1  <span class="methodname"><b>mysqli::query()</b></span> example</b></p>
   <div class="example-contents"><p>Object oriented style</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;check&nbsp;connection&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect_errno</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect_error</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Create&nbsp;table&nbsp;doesn't&nbsp;return&nbsp;a&nbsp;resultset&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TEMPORARY&nbsp;TABLE&nbsp;myCity&nbsp;LIKE&nbsp;City"</span><span style="color: #007700">)&nbsp;===&nbsp;</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Table&nbsp;myCity&nbsp;successfully&nbsp;created.\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Select&nbsp;queries&nbsp;return&nbsp;a&nbsp;resultset&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;Name&nbsp;FROM&nbsp;City&nbsp;LIMIT&nbsp;10"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Select&nbsp;returned&nbsp;%d&nbsp;rows.\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">num_rows</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;free&nbsp;result&nbsp;set&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;If&nbsp;we&nbsp;have&nbsp;to&nbsp;retrieve&nbsp;large&nbsp;amount&nbsp;of&nbsp;data&nbsp;we&nbsp;use&nbsp;MYSQLI_USE_RESULT&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;City"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">MYSQLI_USE_RESULT</span><span style="color: #007700">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Note,&nbsp;that&nbsp;we&nbsp;can't&nbsp;execute&nbsp;any&nbsp;functions&nbsp;which&nbsp;interact&nbsp;with&nbsp;the<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;until&nbsp;result&nbsp;set&nbsp;was&nbsp;closed.&nbsp;All&nbsp;calls&nbsp;will&nbsp;return&nbsp;an<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'out&nbsp;of&nbsp;sync'&nbsp;error&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SET&nbsp;@a:='this&nbsp;will&nbsp;not&nbsp;work'"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Error:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br />}<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>Procedural style</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;check&nbsp;connection&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Create&nbsp;table&nbsp;doesn't&nbsp;return&nbsp;a&nbsp;resultset&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"CREATE&nbsp;TEMPORARY&nbsp;TABLE&nbsp;myCity&nbsp;LIKE&nbsp;City"</span><span style="color: #007700">)&nbsp;===&nbsp;</span><span style="color: #0000BB">TRUE</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Table&nbsp;myCity&nbsp;successfully&nbsp;created.\n"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Select&nbsp;queries&nbsp;return&nbsp;a&nbsp;resultset&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;Name&nbsp;FROM&nbsp;City&nbsp;LIMIT&nbsp;10"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Select&nbsp;returned&nbsp;%d&nbsp;rows.\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_num_rows</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;free&nbsp;result&nbsp;set&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_free_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;If&nbsp;we&nbsp;have&nbsp;to&nbsp;retrieve&nbsp;large&nbsp;amount&nbsp;of&nbsp;data&nbsp;we&nbsp;use&nbsp;MYSQLI_USE_RESULT&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;City"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">MYSQLI_USE_RESULT</span><span style="color: #007700">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Note,&nbsp;that&nbsp;we&nbsp;can't&nbsp;execute&nbsp;any&nbsp;functions&nbsp;which&nbsp;interact&nbsp;with&nbsp;the<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;until&nbsp;result&nbsp;set&nbsp;was&nbsp;closed.&nbsp;All&nbsp;calls&nbsp;will&nbsp;return&nbsp;an<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'out&nbsp;of&nbsp;sync'&nbsp;error&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"SET&nbsp;@a:='this&nbsp;will&nbsp;not&nbsp;work'"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Error:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_free_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">mysqli_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>The above examples will output:</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
Table myCity successfully created.
Select returned 10 rows.
Error: Commands out of sync;  You can&#039;t run this command now
</pre></div>
   </div>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mysqli.query-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="mysqli.real-query.html" class="function" rel="rdfs-seeAlso">mysqli_real_query()</a> - Execute an SQL query</span></li>
    <li class="member"><span class="function"><a href="mysqli.multi-query.html" class="function" rel="rdfs-seeAlso">mysqli_multi_query()</a> - Performs a query on the database</span></li>
    <li class="member"><span class="function"><a href="mysqli-result.free.html" class="function" rel="rdfs-seeAlso">mysqli_free_result()</a> - Frees the memory associated with a result</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="104443""></a>
  <div class="note">
   <strong class="user">marcus at synchromedia dot co dot uk</strong>
   <a href="#104443" class="date">15-Jun-2011 10:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The exact type returned by a successful query is mysqli_result.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103422""></a>
  <div class="note">
   <strong class="user">theyranos at gmail dot com</strong>
   <a href="#103422" class="date">12-Apr-2011 06:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The cryptic "Couldn't fetch mysqli" error message can mean any number of things, including:<br />
<br />
1. You're trying to use a database object that you've already closed (as noted by ceo at l-i-e dot com). Reopen your database connection, or find the call to <span class="default">&lt;?php mysqli_close</span><span class="keyword">(</span><span class="default">$db</span><span class="keyword">); </span><span class="default">?&gt;</span> or <span class="default">&lt;?php $db</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">(); </span><span class="default">?&gt;</span> and remove it.<br />
2. Your MySQLi object has been serialized and unserialized for some reason. Define a wakeup function to re-create your database connection. <a href="http://php.net/__wakeup " rel="nofollow" target="_blank">http://php.net/__wakeup </a><br />
3. Something besides you closed your mysqli connection (in particular, see <a href="http://bugs.php.net/bug.php?id=33772" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=33772</a>)<br />
4. You mixed OOP and functional calls to the database object. (So, you have <span class="default">&lt;?php $db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">() </span><span class="default">?&gt;</span> in the same program as <span class="default">&lt;?php mysqli_query</span><span class="keyword">(</span><span class="default">$db</span><span class="keyword">) </span><span class="default">?&gt;</span>).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102904""></a>
  <div class="note">
   <strong class="user">petrus.jvr</strong>
   <a href="#102904" class="date">14-Mar-2011 03:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When calling multiple stored procedures, you can run into the following error: "Commands out of sync; you can't run this command now".<br />
This can happen even when using the close() function on the result object between calls. <br />
To fix the problem, remember to call the next_result() function on the mysqli object after each stored procedure call. See example below:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// New Connection<br />
</span><span class="default">$db </span><span class="keyword">= new </span><span class="default">mysqli</span><span class="keyword">(</span><span class="string">'localhost'</span><span class="keyword">,</span><span class="string">'user'</span><span class="keyword">,</span><span class="string">'pass'</span><span class="keyword">,</span><span class="string">'database'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Check for errors<br />
</span><span class="keyword">if(</span><span class="default">mysqli_connect_errno</span><span class="keyword">()){<br />
&nbsp;echo </span><span class="default">mysqli_connect_error</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="comment">// 1st Query<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"call getUsers()"</span><span class="keyword">);<br />
if(</span><span class="default">$result</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Cycle through results<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">fetch_object</span><span class="keyword">()){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$user_arr</span><span class="keyword">[] = </span><span class="default">$row</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Free result set<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="comment">// 2nd Query<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"call getGroups()"</span><span class="keyword">);<br />
if(</span><span class="default">$result</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Cycle through results<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">fetch_object</span><span class="keyword">()){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$group_arr</span><span class="keyword">[] = </span><span class="default">$row</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Free result set<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">();<br />
}<br />
else echo(</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">error</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Close connection<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100479""></a>
  <div class="note">
   <strong class="user">Charlie Chan</strong>
   <a href="#100479" class="date">18-Oct-2010 08:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can create similar generic statements for updates and deletes.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">genericUpdate</span><span class="keyword">(</span><span class="default">$tablename</span><span class="keyword">, </span><span class="default">$opts</span><span class="keyword">, </span><span class="default">$where</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$opts </span><span class="keyword">= </span><span class="default">cleanseArray</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$keys </span><span class="keyword">= </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$vals </span><span class="keyword">= </span><span class="default">array_values</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$setString</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$whereString</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$where</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$whereString</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$whereString </span><span class="keyword">= </span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$whereString </span><span class="keyword">= </span><span class="default">$whereString</span><span class="keyword">.</span><span class="string">" AND "</span><span class="keyword">.</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$setString</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$setString </span><span class="keyword">= </span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$setString </span><span class="keyword">= </span><span class="default">$setString</span><span class="keyword">.</span><span class="string">", "</span><span class="keyword">.</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"UPDATE </span><span class="default">$tablename</span><span class="string"> SET "</span><span class="keyword">.</span><span class="default">$setString</span><span class="keyword">.</span><span class="string">" WHERE "</span><span class="keyword">.</span><span class="default">$whereString</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">logDebug</span><span class="keyword">(</span><span class="string">"SQL TO Update KEYS: "</span><span class="keyword">.</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">dbQuery</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
}<br />
<br />
function </span><span class="default">genericDelete</span><span class="keyword">(</span><span class="default">$tablename</span><span class="keyword">, </span><span class="default">$opts</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$opts </span><span class="keyword">= </span><span class="default">cleanseArray</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$keys </span><span class="keyword">= </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$vals </span><span class="keyword">= </span><span class="default">array_values</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$whereString</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$i </span><span class="keyword">== (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$whereString </span><span class="keyword">= </span><span class="default">$whereString</span><span class="keyword">.</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$whereString </span><span class="keyword">= </span><span class="default">$whereString</span><span class="keyword">.</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" = '"</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">"' AND "</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"DELETE FROM "</span><span class="keyword">. </span><span class="default">$tablename </span><span class="keyword">. </span><span class="string">" WHERE " </span><span class="keyword">. </span><span class="default">$whereString</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">logDebug</span><span class="keyword">(</span><span class="string">"SQL TO DELETE KEYS: "</span><span class="keyword">.</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">dbQuery</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Just be sure that you cleanse your arrays before input into DB.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">cleansePureString</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$char </span><span class="keyword">= </span><span class="string">'\\'</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">///[^a-zA-Z0-9\s]/ NON ALPHA<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cleansed </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/[%_'\"]/"</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">, </span><span class="default">$str</span><span class="keyword">); </span><span class="comment">//_, % and '<br />
&nbsp;&nbsp;&nbsp; //logDebug("CLEANSED VAL: ".$cleansed);<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$cleansed</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">cleanseArray</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cleansedArray </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$keys </span><span class="keyword">= </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$vals </span><span class="keyword">= </span><span class="default">array_values</span><span class="keyword">(</span><span class="default">$opts</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$newKey </span><span class="keyword">= </span><span class="default">cleansePureString</span><span class="keyword">(</span><span class="default">$keys</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">],</span><span class="string">"'"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$newVal </span><span class="keyword">= </span><span class="default">cleansePureString</span><span class="keyword">(</span><span class="default">$vals</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">],</span><span class="string">"'"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cleansedArray</span><span class="keyword">[</span><span class="default">$newKey</span><span class="keyword">] = </span><span class="default">$newVal</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$cleansedArray</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100079""></a>
  <div class="note">
   <strong class="user">thomas dekker</strong>
   <a href="#100079" class="date">23-Sep-2010 11:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Building inserts can be annoying. This helper function inserts an array into a table, using the key names as column names:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">private function </span><span class="default">store_array </span><span class="keyword">(&amp;</span><span class="default">$data</span><span class="keyword">, </span><span class="default">$table</span><span class="keyword">, </span><span class="default">$mysqli</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cols </span><span class="keyword">= </span><span class="default">implode</span><span class="keyword">(</span><span class="string">','</span><span class="keyword">, </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">array_values</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) as </span><span class="default">$value</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; isset(</span><span class="default">$vals</span><span class="keyword">) ? </span><span class="default">$vals </span><span class="keyword">.= </span><span class="string">',' </span><span class="keyword">: </span><span class="default">$vals </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$vals </span><span class="keyword">.= </span><span class="string">'\''</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">mysql</span><span class="keyword">-&gt;</span><span class="default">real_escape_string</span><span class="keyword">(</span><span class="default">$value</span><span class="keyword">).</span><span class="string">'\''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">real_query</span><span class="keyword">(</span><span class="string">'INSERT INTO '</span><span class="keyword">.</span><span class="default">$table</span><span class="keyword">.</span><span class="string">' ('</span><span class="keyword">.</span><span class="default">$cols</span><span class="keyword">.</span><span class="string">') VALUES ('</span><span class="keyword">.</span><span class="default">$vals</span><span class="keyword">.</span><span class="string">')'</span><span class="keyword">);<br />
&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
Adapt it to your specific needs.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98535""></a>
  <div class="note">
   <strong class="user">registrations at jdfoxmicro dot com</strong>
   <a href="#98535" class="date">21-Jun-2010 04:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I like to save the query itself in a log file, so that I don't have to worry about whether the site is live.<br />
<br />
For example, I might have a global function:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">UpdateLog </span><span class="keyword">( </span><span class="default">$string </span><span class="keyword">, </span><span class="default">$logfile </span><span class="keyword">)&nbsp; {<br />
&nbsp;&nbsp; </span><span class="default">$fh </span><span class="keyword">= </span><span class="default">fopen </span><span class="keyword">( </span><span class="default">$logfile </span><span class="keyword">, </span><span class="string">'a' </span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">$fwrite </span><span class="keyword">( </span><span class="default">$fh </span><span class="keyword">, </span><span class="default">strftime </span><span class="keyword">(</span><span class="string">'%F %T %z'</span><span class="keyword">).</span><span class="string">" "</span><span class="keyword">.</span><span class="default">$string</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="default">fclose </span><span class="keyword">( </span><span class="default">$fh </span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Then in my mysql function error trapper, something like this:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; $error_msg </span><span class="keyword">= </span><span class="string">"Database error in [page].php / "</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="default">$error_msg </span><span class="keyword">.= </span><span class="default">mysqli_error </span><span class="keyword">( </span><span class="default">$link </span><span class="keyword">).</span><span class="string">" / "</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="default">$error_msg </span><span class="keyword">.= </span><span class="default">$query</span><span class="keyword">;<br />
&nbsp;&nbsp; </span><span class="default">UpdateLog </span><span class="keyword">( </span><span class="default">$error_msg </span><span class="keyword">, </span><span class="default">DB_ERROR_LOG_FILE </span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
I also include the remote IP, user agent, etc., but I left it out of these code samples.&nbsp; And have it e-mail me when an error is caught, too.<br />
<br />
Jeff</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87203""></a>
  <div class="note">
   <strong class="user">Igor</strong>
   <a href="#87203" class="date">24-Nov-2008 06:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
mysqli::query() can only execute one SQL statement.<br />
<br />
Use mysqli::multi_query() when you want to run multiple SQL statements within one query.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85367""></a>
  <div class="note">
   <strong class="user">ceo at l-i-e dot com</strong>
   <a href="#85367" class="date">27-Aug-2008 07:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Translation:<br />
"Couldn't fetch mysqli"<br />
<br />
You closed your connection and are trying to use it again.<br />
<br />
It has taken me DAYS to figure out what this obscure error message means...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80821""></a>
  <div class="note">
   <strong class="user">NUNTIUS</strong>
   <a href="#80821" class="date">01-Feb-2008 01:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This may or may not be obvious to people but perhaps it will help someone.<br />
<br />
When running joins in SQL you may encounter a problem if you are trying to pull two columns with the same name. mysqli returns the last in the query when called by name. So to get what you need you can use an alias.<br />
<br />
Below I am trying to join a user id with a user role. in the first table (tbl_usr), role is a number and in the second is a&nbsp; text name (tbl_memrole is a lookup table). If I call them both as role I get the text as it is the last "role" in the query. If I use an alias then I get both as desired as shown below.<br />
<br />
<span class="default">&lt;?php<br />
$sql </span><span class="keyword">= </span><span class="string">"SELECT a.uid, a.role AS roleid, b.role, <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FROM tbl_usr a<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; INNER JOIN tbl_memrole b<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ON a.role = b.id<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; "</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$obj </span><span class="keyword">= </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">fetch_object</span><span class="keyword">()){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line</span><span class="keyword">.=</span><span class="default">$obj</span><span class="keyword">-&gt;</span><span class="default">uid</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line</span><span class="keyword">.=</span><span class="default">$obj</span><span class="keyword">-&gt;</span><span class="default">role</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line</span><span class="keyword">.=</span><span class="default">$obj</span><span class="keyword">-&gt;</span><span class="default">roleid</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; unset(</span><span class="default">$obj</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; unset(</span><span class="default">$sql</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; unset(</span><span class="default">$query</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">?&gt;<br />
</span>In this situation I guess I could have just renamed the role column in the first table roleid and that would have taken care of it, but it was a learning experience.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75144""></a>
  <div class="note">
   <strong class="user">jcwebb at dicoe dot com</strong>
   <a href="#75144" class="date">15-May-2007 01:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When building apps, i like to see the whole statement when if fails.<br />
<span class="default">&lt;?php<br />
$q</span><span class="keyword">=</span><span class="string">"SELECT somecolumn FROM sometable"</span><span class="keyword">; </span><span class="comment">//some instruction<br />
</span><span class="default">$r</span><span class="keyword">=</span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$DBlink</span><span class="keyword">,</span><span class="default">$q</span><span class="keyword">) or die(</span><span class="default">mysqli_error</span><span class="keyword">(</span><span class="default">$DBlink</span><span class="keyword">).</span><span class="string">" Q="</span><span class="keyword">.</span><span class="default">$q</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>If theres an error (like my numerous typing mistakes) this shows the entire instruction.<br />
Good for development (not so good on production servers - simply find and replace when finished: $r=mysqli_query($DBlink,$q); )<br />
<br />
Hope it helps. Jon</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73840""></a>
  <div class="note">
   <strong class="user">antiriad at gmail dot com</strong>
   <a href="#73840" class="date">12-Mar-2007 10:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
this is a variant of mysqli_query that returns output parameters as a rowset.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">function </span><span class="default">mysqli_exec</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$command</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$i2 </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$i1 </span><span class="keyword">= </span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="string">'@'</span><span class="keyword">, </span><span class="default">$i2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">$i1 </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$field </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$i2 </span><span class="keyword">= </span><span class="default">$i1 </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; while (</span><span class="default">$i2 </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">) &amp;&amp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &gt;= </span><span class="string">'0' </span><span class="keyword">&amp;&amp; </span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &lt;= </span><span class="string">'9'</span><span class="keyword">) ||<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &gt;= </span><span class="string">'A' </span><span class="keyword">&amp;&amp; </span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &lt;= </span><span class="string">'Z'</span><span class="keyword">) ||<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &gt;= </span><span class="string">'a' </span><span class="keyword">&amp;&amp; </span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] &lt;= </span><span class="string">'z'</span><span class="keyword">) ||<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="default">$command</span><span class="keyword">[</span><span class="default">$i2</span><span class="keyword">] == </span><span class="string">'_'</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i2</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$field </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$i1 </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">, </span><span class="default">$i2 </span><span class="keyword">- </span><span class="default">$i1 </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$select</span><span class="keyword">) == </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="string">"select @</span><span class="keyword">{</span><span class="default">$field</span><span class="keyword">}</span><span class="string"> as </span><span class="default">$field</span><span class="string">"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; else&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="default">$select </span><span class="keyword">. </span><span class="string">", @</span><span class="keyword">{</span><span class="default">$field</span><span class="keyword">}</span><span class="string"> as </span><span class="default">$field</span><span class="string">"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$select</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {&nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$command</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$select</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="default">$command</span><span class="keyword">);<br />
&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
an example:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $link </span><span class="keyword">= </span><span class="default">mysqli_connect</span><span class="keyword">(</span><span class="string">'localhost'</span><span class="keyword">, </span><span class="string">'myusr'</span><span class="keyword">, </span><span class="string">'mypass'</span><span class="keyword">) or die (</span><span class="string">'Error connecting to mysql: ' </span><span class="keyword">. </span><span class="default">mysqli_error</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">));<br />
&nbsp; </span><span class="default">mysqli_select_db</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="string">'clips'</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp; </span><span class="default">$user_name </span><span class="keyword">= </span><span class="string">'test'</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysqli_exec</span><span class="keyword">(</span><span class="default">$link</span><span class="keyword">, </span><span class="string">"call do_user_login('</span><span class="default">$user_name</span><span class="string">', @session_id, @msg)"</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">mysqli_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">))<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"session_id : </span><span class="keyword">{</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'session_id'</span><span class="keyword">]}</span><span class="string"> &lt;br&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"msg&nbsp; &nbsp; &nbsp; &nbsp; : </span><span class="keyword">{</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'msg'</span><span class="keyword">]}</span><span class="string"> &lt;br&gt;"</span><span class="keyword">;<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65813""></a>
  <div class="note">
   <strong class="user">info at ff dot net</strong>
   <a href="#65813" class="date">08-May-2006 04:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Calling Stored Procedures<br />
<br />
Beeners' note/example will not work. Use mysqli_multi_query() to call a Stored Procedure. SP's have a second result-set which contains the status: 'OK' or 'ERR'. Using mysqli_query will not work, as there are multiple results.<br />
<br />
<span class="default">&lt;?php<br />
$sQuery</span><span class="keyword">=</span><span class="string">"CALL SomeSP('params')"</span><span class="keyword">;<br />
if(!</span><span class="default">mysqli_multi_query</span><span class="keyword">(</span><span class="default">$sqlLink</span><span class="keyword">,</span><span class="default">$sQuery</span><span class="keyword">)) {<br />
&nbsp; </span><span class="comment">// your error handler <br />
</span><span class="keyword">}<br />
</span><span class="default">$sqlResult</span><span class="keyword">=</span><span class="default">mysqli_store_result</span><span class="keyword">(</span><span class="default">$sqlLink</span><span class="keyword">);<br />
<br />
if(</span><span class="default">mysqli_more_results</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">))</span><span class="comment">//Catch 'OK'/'ERR'<br />
&nbsp; </span><span class="keyword">while(</span><span class="default">mysqli_next_result</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sqlLink</span><span class="keyword">));<br />
</span><span class="default">?&gt;<br />
</span><br />
You will have to rewrite/expand this a bit for more usability of course, but it's just an example.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60473""></a>
  <div class="note">
   <strong class="user">Beeners</strong>
   <a href="#60473" class="date">08-Jan-2006 12:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Stored Procedures.<br />
<br />
Use mysqli_query to call a stored procedure that returns a result set. <br />
<br />
Here is a short example:<br />
<br />
<span class="default">&lt;?php<br />
$mysqli </span><span class="keyword">= new </span><span class="default">mysqli</span><span class="keyword">(</span><span class="default">DBURI</span><span class="keyword">,</span><span class="default">DBUSER</span><span class="keyword">,</span><span class="default">DBPASS</span><span class="keyword">,</span><span class="default">DBNAME</span><span class="keyword">);<br />
if (</span><span class="default">mysqli_connect_errno</span><span class="keyword">()) <br />
{<br />
&nbsp; </span><span class="default">printf</span><span class="keyword">(</span><span class="string">"Connection failed: %s\n"</span><span class="keyword">, </span><span class="default">mysqli_connect_error</span><span class="keyword">());<br />
&nbsp; exit();<br />
}<br />
<br />
</span><span class="default">$SQL </span><span class="keyword">= </span><span class="string">"CALL my_procedure(</span><span class="default">$something</span><span class="string">)"</span><span class="keyword">;<br />
if ( (</span><span class="default">$result </span><span class="keyword">= </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="default">$SQL</span><span class="keyword">))===</span><span class="default">false </span><span class="keyword">)<br />
{<br />
&nbsp; </span><span class="default">printf</span><span class="keyword">(</span><span class="string">"Invalid query: %s\nWhole query: %s\n"</span><span class="keyword">, </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">error</span><span class="keyword">, </span><span class="default">$SQL</span><span class="keyword">);<br />
&nbsp; exit();<br />
}<br />
<br />
while (</span><span class="default">$myrow </span><span class="keyword">= </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">fetch_array</span><span class="keyword">(</span><span class="default">MYSQLI_ASSOC</span><span class="keyword">))<br />
{<br />
&nbsp; </span><span class="default">$aValue</span><span class="keyword">[]=</span><span class="default">$myrow</span><span class="keyword">[</span><span class="string">"a"</span><span class="keyword">];<br />
&nbsp; </span><span class="default">$bValue</span><span class="keyword">[]=</span><span class="default">$myrow</span><span class="keyword">[</span><span class="string">"b"</span><span class="keyword">];<br />
}<br />
</span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span>I hope this saves someone some time.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55555""></a>
  <div class="note">
   <strong class="user">andrey at php dot net</strong>
   <a href="#55555" class="date">07-Aug-2005 12:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
WARNING: This function was buggy on 64bit machines till 5.0.5. Affected versions 5.0.0-5.0.4. The problem appears when a value for the third parameter is passed - this will lead to instant FALSE returned by the function. Therefore if you need to use unbuffered query don't use this function with the aforementioned versions but you mysqli_real_query() and mysqli_use_result().<br />
If you have the rights to patch you PHP installation the fix is easy:<br />
In file ext/mysqli/myslqi_nonapi.c, function PHP_FUNCTION(mysqli_query)<br />
change<br />
unsigned int resultmode=0;<br />
to<br />
unsigned long resultmode=0;<br />
<br />
Thanks!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="44707""></a>
  <div class="note">
   <strong class="user">hunreal at gmail dot com</strong>
   <a href="#44707" class="date">13-Aug-2004 02:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use difference collation/character for connect, result.<br />
You can set the collation before your query.<br />
<br />
E.g. want to set the collation to utf8_general_ci <br />
you can send the query "SET NAMES 'utf8'" first<br />
<br />
<span class="default">&lt;?php<br />
$mysqli</span><span class="keyword">=new </span><span class="default">mysqli</span><span class="keyword">(</span><span class="string">'localhost'</span><span class="keyword">, </span><span class="string">'root'</span><span class="keyword">, </span><span class="string">'password'</span><span class="keyword">, </span><span class="string">'test'</span><span class="keyword">);<br />
</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"SET NAMES 'utf8'"</span><span class="keyword">);<br />
</span><span class="default">$q</span><span class="keyword">=</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">"select * from test"</span><span class="keyword">);<br />
while(</span><span class="default">$r</span><span class="keyword">=</span><span class="default">$q</span><span class="keyword">-&gt;</span><span class="default">fetch_assoc</span><span class="keyword">()) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$r</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
There are many variables about character settings.<br />
By running sql command, SHOW VARIABLES LIKE 'char%'; <br />
There are some variables control the character usage.<br />
<br />
character_set_client<br />
character_set_connection<br />
character_set_database<br />
character_set_results<br />
character_set_server<br />
character_set_system<br />
<br />
Also SET NAMES can repalce with one or some settings like SET character_set_results='utf8';</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.prepare.html">mysqli::prepare</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.real-connect.html">mysqli::real_connect</a></div>
 <div class="up"><a href="class.mysqli.html">mysqli</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
